<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title></title>
    <link>https://pawelurbanek.com</link>
    <description>
      Paweł Urbanek - Full Stack developer, specializing in Ruby on Rails and JavaScript. Experienced in building scalable and performant APIs for startups and refactoring legacy codebases. Blogging about web development related topics.
    </description>
    
        
            <item>
                <title>Reconsider Blogging on Medium if You Care about SEO</title>
                <link>https://pawelurbanek.com/medium-blogging-platform-seo</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Hammer represents that Medium is a wrong tool for your blog" src="/assets/medium-is-wrong-tool-ad83c3883553a91a35dd91040da0c5c8655907b78c4baf1beac65c9e2cb4d387.jpg" /></p>

<p>Medium is an extremely popular blogging platform for both newcomers and expert tech-savvy bloggers. I’ve noticed the serious SEO related issue with using it as your main blogging tool. Read on if you are curious how Medium hurts your internet brand and what’s the alternative.</p>

<h2 id="authority-of-your-domain-seo-ranking">Authority of your domain (SEO ranking)</h2>

<p>Search engine optimization is a complex subject. One of the few things that are known for sure is that so-called backlinks can improve website’s position in the search results. The more backlinks from good quality sources, the better it ranks in search results for a given term.</p>

<p>One caveat is that a backlink has to be an <code class="highlighter-rouge">&lt;a&gt;</code> HTML element without a <code class="highlighter-rouge">rel="nofollow"</code> added to it. A <code class="highlighter-rouge">nofollow</code> attribute is a way to tell the search engine <em>“Ok, he is here, but I don’t know this guy.”</em> and deprive the link of all the authority value it would provide otherwise.</p>

<p>Guess what?</p>

<p>Medium adds a <code class="highlighter-rouge">rel="nofollow"</code> to ALL the links by default.</p>

<h3 id="what-are-the-practical-implications-of-nofollow">What are the practical implications of <code class="highlighter-rouge">nofollow</code>?</h3>

<p>Let’s say you are a software company and your website is <code class="highlighter-rouge">www.the-best-devs-out-there.com</code>. You hire a lot of smart guys and one of them publishes a technical blog post on Medium. The blog post goes viral, it is shared a lot on social media and gets featured in a couple of newsletters. Newsletters usually don’t add <code class="highlighter-rouge">nofollow</code> attribute to featured links and could have a lot of authority in the eyes of Google themselves.</p>

<p>Value of all the backlinks from social media and newsletters goes directly to Medium. Although your website <code class="highlighter-rouge">www.the-best-devs-out-there.com</code> is provided in the blog post footer, it is a <code class="highlighter-rouge">nofollow</code> link so does not give any authority (even indirectly) to your website.</p>

<p>If the blog post was published on <code class="highlighter-rouge">www.the-best-devs-out-there.com/blog</code> instead than all the valuable sources linking to your domain could significantly boost your Google ranking. Not only the ranking of the page with the viral blog post but also the homepage. It would help you rank higher for the keywords you are targeting there (e.g. <code class="highlighter-rouge">best outsourcing team</code>, <code class="highlighter-rouge">quality developers</code>).</p>

<p>If you have your own website and still publishing blog posts on Medium you are missing a great opportunity for improving SEO.</p>

<h2 id="hidden-costs-of-publishing-on-medium">Hidden costs of publishing on Medium</h2>

<p>“But Medium is for free…”</p>

<p>That’s right, you can start publishing on Medium without paying a cent. You can save money you would spend on hosting if you used a custom blogging tool.</p>

<h3 id="lets-do-some-quick-maths">Let’s do some quick maths:</h3>

<p>If you are a tech person than an hour of your work is probably worth tens of $$. One blog post is at least a couple of hours of work and could be valued in hundreds. If you write a blog post a couple of times a month you offer ~1000$ worth of work to Medium for free.</p>

<p>My hosting costs for this blog are 7$/month. I use <a href="https://jekyllrb.com/" target="_blank">jekyll</a> together with <a href="https://pages.github.com/" target="_blank">GitHub pages</a> and Cloudflare. It could be for free if I kept it in a public repo.</p>

<p>There are also yearly costs of domain renewal. You can check out my other blog post if that’s an issue for you. You can <a href="https://pawelurbanek.com/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/">save money by setting up multiple domains with free SSL</a>.</p>

<h3 id="benefits-of-a-custom-blog-engine">Benefits of a custom blog engine</h3>

<p>I use an amazing <a href="http://pixyll.com/" target="_blank">pixyll template</a> for this blog. Out of the box it gives you a very nice looks,</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Proper</span>
  <span class="k">def</span> <span class="nf">syntax</span>
    <span class="ss">:highlighting</span>
  <span class="k">end</span>

  <span class="c1"># not some GitHub gists</span>
<span class="k">end</span></code></pre></figure>

<p>and a lot of <a href="http://pixyll.com/jekyll/pixyll/2014/06/10/see-pixyll-in-action/" target="_blank">other bells and whistles</a>, in some cases superior to Medium.</p>

<p>It is true that until now I did spend some time tinkering with it, e.g. by <a href="https://pawelurbanek.com/2018/02/16/seo-tips-for-technical-bloggers-and-programming-blogs-in-2018/">applying some SEO techniques and adding AMP</a> but you don’t need that to get started. Needless to say that customizing your blogging template is a great way to polish your developer skills.</p>

<p>If you are not a tech-savvy person there are plenty of other solutions available to you:</p>

<p><a href="https://wordpress.org/" target="_blank">Wordpress</a></p>

<p><a href="https://ghost.org/" target="_blank">Ghost</a></p>

<p>to name the most popular. Each of those tools gives you more control than Medium over the content you publish and does not lock it up in a centralized network.</p>

<p>It will be a bit more work than a plug and play Medium editor, but it is worth the effort.</p>

<h2 id="summary-of-medium-seo-effects">Summary of Medium SEO effects</h2>

<p>I know this blog post just scratches the surface of a really complex problem. Let me know if I got something wrong. In any case selling your personal brand for a fancy WYSIWYG editor does not seem to be the best trade-off.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/medium-blogging-platform-seo</guid>
                <description>
                    
                    Medium is an extremely popular blogging platform for both newcomers and expert tech-savvy bloggers. I've noticed the serious SEO related issue with using it as your main blogging tool. Read on if you are curious how Medium hurts your internet brand and what's the alternative.
                    
                </description>
                <pubDate>Tue, 20 Feb 2018 09:00:35 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>SEO Tips for Programming Blogs and Technical Bloggers in 2018</title>
                <link>https://pawelurbanek.com/2018/02/16/seo-tips-for-technical-bloggers-and-programming-blogs-in-2018/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Spider web represents blog SEO optimization techniques" src="/assets/web-pages-seo-optimization-338c1cc3524f795069ddc78e84344c4ee56d238d0c24635b5234b124131a5721.jpg" /></p>

<p>I’ve noticed that many programming blogs I read don’t implement certain simple SEO techniques, and bloggers could be missing valuable traffic opportunities. I will describe a couple of search engine optimization tips which can improve your technical blog’s SEO ranking and search results position in 2018. I will cover topics like Google’s Featured Snippets, AMP, best rendering speed tips and social media meta tags.</p>

<p>I use <a href="https://jekyllrb.com/" target="_blank">jekyll</a> based <a href="http://pixyll.com/" target="_blank">pixyll template</a> for this blog but most of the tips should be applicable to all custom blog engines. If you use Medium as your only blogging platform (<em>protip: you probably shouldn’t</em>) none of these tips will be applicable.</p>

<p>Here’s what you can do:</p>

<h2 id="add-open-graph-and-twitter-meta-tags-to-improve-social-sharing">Add Open Graph and Twitter meta tags to improve social sharing</h2>

<p>Social media sharing is one of the top sources of traffic to my blog. You can affect how your post looks when shared on social media sites by using so-called “Open Graph meta tags”. Which of these Twitter cards would you rather click?</p>

<p><img class="center-image" alt="Bloger's post shared on Twitter without correct SEO meta tags" src="/assets/seo-without-og-meta-tags-13e212c114ad9940f51d43f2449e262b040a62582ace4e490b57c3367433727d.png" /></p>
<div class="center annotation">Blogger's post shared on Twitter without correct meta tags</div>

<p><img class="center-image" alt="Blogger's post shared on Twitter with correct SEO meta tags" src="/assets/seo-with-og-meta-tags-f5ddff6c63fb95070a8fe789b709d9561b41753eeb2318373ce2ebe60a10982b.png" /></p>
<div class="center annotation">Blogger's post shared on Twitter with correct meta tags</div>

<p>Currently my blog uses the following meta tags:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:locale"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:type"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:title"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:url"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:site_name"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image:width"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"og:image:height"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"article:published_time"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:card"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:image"</span> <span class="na">content=</span><span class="s">"..."</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:site"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:creator"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:title"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:description"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"twitter:url"</span> <span class="na">content=</span><span class="s">"..."</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>The best way to check how your page will display on social media sites is to use these tools:</p>

<p><a href="https://cards-dev.twitter.com/validator" target="_blank">Twitter Card Validator</a></p>

<p><a href="https://developers.facebook.com/tools/debug/" target="_blank">Facebook Open Graph debugger</a></p>

<h2 id="add-accelerated-mobile-pages-amp-to-your-blog">Add Accelerated Mobile Pages (AMP) to your blog</h2>

<p>Although they are the most hated technology on the Hacker News, <a href="https://www.ampproject.org/" target="_blank">Accelerated Mobile Pages</a> are here to stay.</p>

<p>As long as it’s Uncle Google who decides if anyone can find your website, you have to play by his rules. Adding an AMP support is not a rocket science and could be a positive ranking signal which increases your chance of appearing in Google’s search results. Also (together with Structured Data) it is the only way for your website to appear in Google’s Featured Snippets and Chrome’s suggested articles.</p>

<p><img class="center-image" alt="Google search result AMP page about Rails" src="/assets/limit-rails-memory-usage-e9062d0dbdd28fa175539ac8de75058d767c7e1ce1cbfcfc8652b045668459c5.png" /></p>
<div class="center annotation">A little lightning icon indicates an Accelerated Mobile Page</div>

<p>I added AMP support to this blog using <a href="https://github.com/juusaw/amp-jekyll" target="_blank">amp-jekyll</a> together with a template from <a href="https://github.com/ageitgey/amplify" target="_blank">amplify</a>. When your AMP page version is ready you can validate and submit it using this tool:</p>

<p><a href="https://search.google.com/test/amp" target="_blank">Validate AMP website</a></p>

<p><img class="center-image" alt="Non AMP blog post version" src="/assets/oryginal-page-version-10af9e578b51754c3f0739814e8c83d0166e8614fad2a2ce3866a8b9f9e336e2.png" /></p>
<div class="center annotation">Standard page version on a mobile browser</div>

<p><br /></p>

<p><img class="center-image" alt="Accelerated Mobile Pages blog post version" src="/assets/amp-page-version-d8c902135da08a7a82b221f60d7d1d0c4e1b63393ea6785533fc8eef66803df6.png" /></p>
<div class="center annotation">AMP version on a mobile browser</div>

<p>BTW bad news for other backend developers who have to write their own CSS: <code class="highlighter-rouge">important!</code> is not permitted and will result in AMP validation error :(</p>

<h3 id="add-structured-data-to-enable-featured-snippets">Add Structured Data to enable Featured Snippets</h3>

<p>As I mentioned adding Structured Data enables your AMP website to appear in Google’s featured snippet top search result:</p>

<p><img class="center-image" alt="Add Structured Data and AMP to appear Google featured snippets" src="/assets/seo-google-featured-snippet-1ca71bf03c566e7d98b9e53cb53eb87546201e4c923451e704b2afb84edbdb54.png" /></p>
<div class="center annotation">Featured Snippet thanks to AMP and Structured Data</div>

<p>This is a <a href="http://schema.org/BlogPosting" target="_blank">schema.org BlogPosting</a> entry scaffold I use for this blog:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/ld+json"</span><span class="nt">&gt;</span>
  <span class="p">{</span>
    <span class="s2">"@context"</span><span class="p">:</span> <span class="s2">"http://schema.org"</span><span class="p">,</span>
    <span class="s2">"@type"</span><span class="p">:</span> <span class="s2">"BlogPosting"</span><span class="p">,</span>
    <span class="s2">"mainEntityOfPage"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"@type"</span><span class="p">:</span><span class="s2">"WebPage"</span><span class="p">,</span>
      <span class="s2">"@id"</span><span class="p">:</span><span class="s2">"..."</span>
    <span class="p">},</span>
    <span class="s2">"headline"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
    <span class="s2">"image"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"@type"</span><span class="p">:</span> <span class="s2">"ImageObject"</span><span class="p">,</span>
      <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
      <span class="s2">"height"</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
      <span class="s2">"width"</span><span class="p">:</span> <span class="mi">1024</span>
    <span class="p">},</span>
    <span class="s2">"datePublished"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
    <span class="s2">"dateModified"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
    <span class="s2">"author"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"@type"</span><span class="p">:</span> <span class="s2">"Person"</span><span class="p">,</span>
      <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"..."</span>
    <span class="p">},</span>
    <span class="s2">"publisher"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"@type"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
      <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
      <span class="s2">"logo"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"@type"</span><span class="p">:</span> <span class="s2">"ImageObject"</span><span class="p">,</span>
        <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
        <span class="s2">"width"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
        <span class="s2">"height"</span><span class="p">:</span> <span class="mi">60</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"..."</span><span class="p">,</span>
    <span class="s2">"keywords"</span><span class="p">:</span> <span class="s2">"..."</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span></code></pre></figure>

<div class="center annotation">A sample structured data for a blog post. Publisher logo must have 60x600 size.</div>

<p>Remember that adding an AMP support and Structured Data does not guarantee that your website will be featured. It has to be in top 10 results for a given search phrase (but not necessarily first). All you can do is double check if Structured Data entry is correct using <a href="https://search.google.com/structured-data/testing-tool/" target="_blank">this tool</a> and make sure that all other mobile and SEO optimisations are in place. So far I managed to see a featured snippet for only one of my blog posts using a bit clunky keywords. But I see a decent traffic coming from <code class="highlighter-rouge">googleapis.com/auth/chrome-content-suggestions</code> source and it means that users see and arrive to my website via Chrome’s suggested articles section.</p>

<h3 id="backlink-from-amp-to-the-original-version-of-the-blog-post">Backlink from AMP to the original version of the blog post</h3>

<p>If your website has an AMP version, visitors might arrive to it not only through Google. I’ve noticed that when I publish links to my blog posts on Twitter, after clicking it on my mobile browser I am redirected to an AMP version, not the original one.</p>

<p>One problem here is that it is an AMP page hosted by you, not a Google CDN. It means that a top link to the original version is missing. You should add it yourself if you want your visitors to have optional access to e.g. Disqus comments, which are not supported on AMP.</p>

<h3 id="setup-google-analytics-for-amp">Setup Google Analytics for AMP</h3>

<p>You need to import a special version of Google Analytics and explicitly track visitor page view to obtain tracking data from AMP pages:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">  <span class="nt">&lt;script </span><span class="na">async</span>
    <span class="na">custom-element=</span><span class="s">"amp-analytics"</span>
    <span class="na">src=</span><span class="s">"https://cdn.ampproject.org/v0/amp-analytics-0.1.js"</span>
  <span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;amp-analytics</span> <span class="na">type=</span><span class="s">"googleanalytics"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/json"</span><span class="nt">&gt;</span>
    <span class="p">{</span>
      <span class="s2">"vars"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"account"</span><span class="p">:</span> <span class="s2">"YOUR-GOOGLE-ID"</span>
      <span class="p">},</span>
      <span class="s2">"triggers"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"trackPageview"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"on"</span><span class="p">:</span> <span class="s2">"visible"</span><span class="p">,</span>
          <span class="s2">"request"</span><span class="p">:</span> <span class="s2">"pageview"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/amp-analytics&gt;</span></code></pre></figure>

<p>BTW I still don’t know how to define a <code class="highlighter-rouge">trigger</code> entry to differentiate AMP traffic from the standard one in Google Analytics. Tips are appreciated.</p>

<h2 id="optimise-rendering-speed-and-mobile-friendliness">Optimise rendering speed and “mobile friendliness”</h2>

<p>In 2016 Google announced its “Mobile-first” approach to ranking pages. How fast page loads and <em>feels</em> for mobile users is a crucial ranking signal which should be optimised. These are some great tools allowing you to detect your website’s mobile shortcomings:</p>

<p><a href="https://developers.google.com/speed/pagespeed/insights/" target="_blank">Google Page Speed Insights</a></p>

<p><a href="https://search.google.com/test/mobile-friendly" target="_blank">Mobile-Friendly Test</a></p>

<p><a href="https://www.webpagetest.org/" target="_blank">Web Page Test</a></p>

<p>Here are a couple of optimizations I successfully applied to this blog:</p>

<h3 id="leverage-browser-caching-with-assets-preprocessor">Leverage browser caching with assets preprocessor</h3>

<p>Google’s speed test will not be satisfied as long as you don’t cache your static assets for at least 8 days. To avoid problems with client browsers keeping outdated resources you should use the assets preprocessor. For this blog, I am using <a href="https://github.com/envygeeks/jekyll-assets" target="_blank">jekyll-assets</a> to add digest tags to all the resources. Whenever an asset changes its digest tag in URL is modified so I can cache everything without worrying that outdated version is ever served.</p>

<p>One problem is that you cannot cache external resources like Disqus JavaScript library of Google Analytics itself. There are some hacky ways to overcome it. You could periodically download up-to-date files to your server using scheduled tasks, and add caching headers but I did not try to do it yet.</p>

<p>I use <a href="https://cloudflare.com" target="_blank">Cloudflare</a> to configure browser caching headers.</p>

<h3 id="optimize-and-resize-images">Optimize and resize images</h3>

<p>This one is quite easy to fix. Just process all your images with <a href="https://compressor.io/" target="_blank">compressor.io</a>. Also, make sure they are only as big as needed to display properly in all resolutions. I’ve only just recently removed a 6000x4000 sized image from landing page of <a href="https://abot.apki.io" target="_blank">Abot - Anonymous feedback bot for Slack</a>.</p>

<h3 id="reconsider-website-dependencies">Reconsider website dependencies</h3>

<p>For me an interesting side effect of playing with those optimization tools was that I started thinking more about the code I embed on my websites. Do I really need a fancy live chat support on a landing page when a standard contact form would do? Do I need an interactive like/follow button embedding KBs of spyware my visitors will probably block anyway? Maybe I could just add an icon linking to my account/fan page instead?</p>

<p>It is entirely up to you but spoiling your website mobile friendliness and SEO ranking for a couple of bells and whistles could not be the best tradeoff.</p>

<h3 id="check-the-optimization-results">Check the optimization results</h3>

<p><img class="center-image" alt="Google speed ranking on mobile" src="/assets/google-seo-ranking-mobile-3d563400e51ae93355907a978af2f8af63bd0574f5fbf14f084af8985d0b4986.png" />
<img class="center-image" alt="Google speed ranking on desktop" src="/assets/google-seo-ranking-desktop-cd8990d85efbeff847883794ce42e227e55dcf3a9904f265a5503b87bd291099.png" /></p>
<div class="center annotation">After a couple of SEO optimizations Google speed ranking is finally green.</div>

<p>As you can see this blog is quite swifty according to Google speed test. When I started SEO and rendering speed oriented optimization it was around 70. Please note that mobile version assessed here is the standard one, not an AMP.</p>

<h2 id="use-ssl-for-your-blog">Use SSL for your blog</h2>

<p>There is no excuse on why a technical blog (or any website) in 2018 should not have an SSL support. Since 2014 HTTPS is a ranking signal for the Googlebot. You can check out my other blog posts for tips on how to <a href="https://pawelurbanek.com/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/">setup a free wildcard SSL with Cloudflare</a> and <a href="https://pawelurbanek.com/2018/01/29/setup-ssl-proxy-for-insecure-browser-content-with-ruby-and-nginx/">serve all browser assets via HTTPS using a simple SSL proxy</a>.</p>

<h2 id="dont-trust-google-analytics-traffic-stats">Don’t trust Google Analytics traffic stats</h2>

<p>Maybe it’s not standard search engine optimization tip but worth mentioning anyway. Google Analytics is amazing. Only terribly inaccurate:</p>

<p><img class="center-image" alt="Google Analytics stats" src="/assets/inaccurate-seo-stats-3827a4a1b618f52cba374f34a90733aad3cd64dbc2d1b11b4388685a9c5ffe9e.png" /></p>

<p><img class="center-image" alt="CloudFlare stats" src="/assets/cloudflare-seo-stats-80f7df3558c3d6626087648c8c3a3af217086af40172e07b043890392590ab92.png" /></p>
<div class="center annotation">Google Analytics report ~500% less traffic than Cloudflare</div>

<p>I was surprised to see how much both figures differ. I am targeting tech-savvy users in my blog posts so it probably increases the ratio of ad/tracking blockers enabled, but still, 500% difference is huge. If you make any business decisions based on Google Analytics data remember to take it into account. You can <a href="https://pawelurbanek.com/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/">add Cloudflare to your website for free</a>. Contrary to Google Analytics it works by proxying all the traffic through their servers so is impossible to block.</p>

<h2 id="summary-of-seo-tips-for-bloggers">Summary of SEO tips for bloggers</h2>

<p>Some people say that there is no such thing as search engine optimization techniques. You just need to create a valuable content. But why not help this valuable content get discovered by optimizing it?</p>

<p>I hope you did not know at least one of those SEO techniques and will notice a traffic increase after applying it to your website. Let me know if I got something wrong or you know other ways to improve a programming blog’s SEO ranking.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/02/16/seo-tips-for-technical-bloggers-and-programming-blogs-in-2018/</guid>
                <description>
                    
                    I've noticed that many programming blogs I read don't implement certain simple SEO techniques, and bloggers could be missing valuable traffic opportunities. I will describe a couple of search engine optimization tips which can improve your technical blog's SEO ranking and search results position in 2018. I will cover topics like Google's Featured Snippets, AMP, best rendering speed tips and social media meta tags.
                    
                </description>
                <pubDate>Fri, 16 Feb 2018 09:00:40 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Ruby on Rails Simple Service Objects and Testing in Isolation</title>
                <link>https://pawelurbanek.com/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Gears represent Rails Service objects" src="/assets/rails-service-object-gear-00fca702cf4d691fd506ffd727dbaace1ece26354f18c96c644c4e7ac7ea747d.jpg" /></p>

<p>Service Objects are not a silver bullet but they can take you a long way in modeling your Rails app’s domain logic. In this blog post, I will describe how I usually work with service object pattern in a structured way. I will also cover testing in isolation with mocked services layer.</p>

<p>I first read about service objects in a great blog post about <a href="https://codeclimate.com/blog/7-ways-to-decompose-fat-activerecord-models/" target="_blank">7 Patterns to Refactor Fat ActiveRecord Models</a>. Since then a new article about them pops up every now and then. I decided to add my two cents.</p>

<h2 id="reasoning-behind-service-objects-in-rails-apps">Reasoning behind Service Objects in Rails apps</h2>

<p>A service object is a way to encapsulate an app’s logic to prevent fat models and cluttered controllers. It is recommended that they should have only one public method. Sticking to this rule enforces you to follow a single responsibility principle and helps to avoid the trap of overcomplicating your services code.</p>

<p>I usually follow the convention where a service object has only one public class method <code class="highlighter-rouge">call</code>. This method instantiates a new service instance and executes it. Let’s look at some code:</p>

<p><code class="highlighter-rouge">app/services/web/user_login.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">UserLogin</span>
  <span class="nb">attr_reader</span> <span class="ss">:omniauth_data</span><span class="p">,</span> <span class="ss">:team_id</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">)</span>
    <span class="vi">@omniauth_data</span> <span class="o">=</span> <span class="n">omniauth_data</span>
    <span class="vi">@team_id</span> <span class="o">=</span> <span class="n">team_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Because <a href="https://pawelurbanek.com/2018/01/08/productive-laziness-optimize-your-shell-workflow/">I am lazy</a> some time ago I created a simple gem. <a href="https://github.com/pawurb/smart_init" target="_blank">Smart Init</a> saves me some typing when creating service objects. This is how a previous example looks written with the help of my gem:</p>

<p><code class="highlighter-rouge">app/services/web/user_login.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">UserLogin</span>
  <span class="kp">extend</span> <span class="no">SmartInit</span>

  <span class="n">initialize_with</span> <span class="ss">:omniauth_data</span><span class="p">,</span> <span class="ss">:team_id</span>
  <span class="n">is_callable</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>It’s not only about avoiding boilerplate code but more about having a default scaffold for building services and saving yourself some thinking. Alternatively, you could use <code class="highlighter-rouge">Struct</code> but it does not check for a number of parameters provided in the initializer, exposes getters and instantiates unnecessary class instances.</p>

<h2 id="mock-service-objects-in-controller-specs">Mock Service Objects in controller specs</h2>

<p>Naming one public method <code class="highlighter-rouge">call</code> is an optimal solution. Not only because <code class="highlighter-rouge">UserAuthenticator#authenticate</code> is unnecessarily redundant, but it allows you to mock your services using a proc object. It comes super handy when you want to test other parts of your application in isolation from services layer.</p>

<p>Let’s say that you want to test how your controller behaves depending on whether a payment operation was successful or not. In theory, your specs could execute the whole checkout process e.g. by using a <a href="https://github.com/vcr/vcr" target="_blank">VCR gem</a>. Unfortunately for any non-trivial flow, it could be difficult to simulate all possible edge cases in an integration test.</p>

<p>Instead, you can use a simple proc object to simulate any outcome of running your services. Let’s take a look at an example controller and spec:</p>

<p><code class="highlighter-rouge">app/controllers/web/subscriptions_controller.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">BaseController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">if</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">head</span> <span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="mi">400</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="no">ExceptionNotifier</span><span class="p">.</span><span class="nf">notify_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">head</span> <span class="mi">500</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p><code class="highlighter-rouge">spec/controllers/web/subscriptions_controller_spec.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"#create"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"payment successful"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1"># proc object, it responds to a 'call' method</span>
          <span class="o">-&gt;</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">201</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"payment failed"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">-&gt;</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">400</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"something went really wrong"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="k">raise</span> <span class="s2">"Unexpected error"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">500</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>As you can see not only can you mock returned values but also simulate any kind of side effect because of proc objects being callable chunks of code. Here I used it to raise a runtime exception, but it could be any code. It gives you a real flexibility in simulating edge cases without doing a complex data setup with fixtures/factories.</p>

<h2 id="beyond-true-and-false-enums-for-control-flow">Beyond true and false; “Enums” for control flow</h2>

<p>In the previous example, I used a single if/else statement to detect if an operation was successful and exception handling for critical edge cases. In practice, operation result is not always as simple as success or failure and you might need to handle more than 2 possible outcomes.</p>

<p>I work mainly in Swift nowadays and one of the features I miss the most when I come back to Ruby are enums. I am not talking about database Rails enums here. A real enum is a variable which can have only predefined values and it is validated during a compile time.</p>

<p>Obviously, there is no such thing as compile-time validation in Ruby, and the closest thing to enums I managed to come up with is an array of constants. You could use this technique to provide at least a minimal protection from typos if you would like your services to return different “status codes” as a result of their execution. Let’s take a look at an example:</p>

<p><code class="highlighter-rouge">app/services/subscription/maker.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Subscription</span><span class="o">::</span><span class="no">Maker</span>
  <span class="kp">extend</span> <span class="no">SmartInit</span>

  <span class="n">initialize_with</span> <span class="ss">:params</span>
  <span class="n">is_callable</span>

  <span class="no">RESULTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="no">PAYMENT_SUCCESS</span> <span class="o">=</span> <span class="ss">:payment_success</span><span class="p">,</span>
    <span class="no">INSUFFICIENT_FOUNDS</span> <span class="o">=</span> <span class="ss">:insufficient_founds</span><span class="p">,</span>
    <span class="no">INVALID_CARD_DATA</span> <span class="o">=</span> <span class="ss">:invalid_card_data</span><span class="p">,</span>
    <span class="no">GATEWAY_TIMEOUT</span> <span class="o">=</span> <span class="ss">:gateway_timeout</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="no">PAYMENT_SUCCESS</span> <span class="k">if</span> <span class="n">sth</span>
    <span class="k">return</span> <span class="no">INSUFFICIENT_FOUNDS</span> <span class="k">if</span> <span class="n">sth_else</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>In the controller you can switch on a result of service execution:</p>

<p><code class="highlighter-rouge">app/controllers/web/subscriptions_controller.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">BaseController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">case</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">PAYMENT_SUCCESS</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">INSUFFICIENT_FOUNDS</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">INVALID_CARD_DATA</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">GATEWAY_TIMEOUT</span>
      <span class="o">...</span>
    <span class="n">default</span>
      <span class="k">raise</span> <span class="s2">"It should never happen! ☠☠☠"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>As you can see because of how Ruby handles constant namespaces, you can access them directly and not necessarily through <code class="highlighter-rouge">RESULTS</code> array. It is a bit verbose but still better than tracking a typo bug for hours.</p>

<h2 id="final-remarks">Final remarks</h2>

<p>I hope that some of those tips would prove useful in how you work with services in your apps. I am open to suggestions on what could be improved in what I describe.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation/</guid>
                <description>
                    
                    Service Objects are not a silver bullet but they can take you a long way in modeling your Ruby on Rails app's domain logic. In this blog post, I will describe how I usually work with service object pattern in a structured way. I will also cover a simple testing in isolation with mocked services layer.
                    
                </description>
                <pubDate>Mon, 12 Feb 2018 10:00:05 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Optimize Rails Performance with Redis Caching and Rack Middleware</title>
                <link>https://pawelurbanek.com/2018/02/05/optimize-rails-performance-bottleneck-with-caching-and-rack-middleware/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Fast car symbolizing Ruby on Rails performance and speed" src="/assets/rails-performance-optimized-5277e2aeef07e281097345499e86ed0a58ed300b7aaf7599b06c965b3e058817.jpg" /></p>

<p>According to (a bit exaggerated) Pareto principle, 5% of your Rails app endpoints could account for 95% of performance issues. In this blog post I will describe how I improved a performance of my Rails application’s bottleneck endpoint by over 500% using a simple Redis caching technique and a custom Rack middleware.</p>

<p><img class="center-image" alt="Results of Rails app performance optimization benchmarks" src="/assets/rails-app-benchmark-chart-7d586e0d026c7434633b160eb204d3213b129a3c72b847898dddb820b5e46456.png" />
<span class="annotation">Over 500% performance improvement</span></p>

<p>Benchmarks were conducted using <a href="https://github.com/JoeDog/siege" target="_blank">Siege</a> on a 2015 Mac Book Pro with 16GB RAM and 2,2 GHz Intel Core i7. I’ve executed them against Rails app running locally in a production mode with a copy of a production database using Puma server with 2 workers, 16 threads each. I’ve used the following Siege settings:</p>

<p><code class="highlighter-rouge">siege --time=60s --concurrent=20</code></p>

<p>Read on if you’re interested in how the improvement was achieved.</p>

<h2 id="before-rails-performance-optimization">Before Rails performance optimization</h2>

<p>A detailed performance benchmark results before I started the whole optimization process:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Transactions:                    5489 hits
Availability:                  100.00 %
Elapsed time:                   59.47 secs
Data transferred:              868.35 MB
Response time:                   0.22 secs
Transaction rate:               92.30 trans/sec
Throughput:                     14.60 MB/sec
Concurrency:                    19.94
Successful transactions:         5489
Failed transactions:                0
Longest transaction:             0.63
Shortest transaction:            0.03</code></pre></figure>

<p>I decided this endpoint would a good candidate for optimization because it was used by both landing page React frontend and all of the iOS mobile clients on startup. Also, data was the same regardless of which user requests it, so I would be able to cache one version and present it to everyone.</p>

<p>One caveat was that the endpoint accepts an optional param <code class="highlighter-rouge">discounted_by</code>. Because it is a continuous param type (all values from 0.0 to 100.0 are valid) it would be impossible to cache all the potential queries. If your query accepts only one param of discrete type (e.g. <code class="highlighter-rouge">category</code>), you could consider caching all the possible results.</p>

<p>I ended up caching results of the query performed without param and serve cached version to clients which did not provide <code class="highlighter-rouge">discounted_by</code> value in the request.</p>

<p>If you don’t know which of your app’s endpoints could be worth optimizing then <a href="https://newrelic.com/" target="_blank">New Relic</a> and <a href="https://github.com/ankane/pghero" target="_blank">pghero</a> are great starting points for an investigation.</p>

<h2 id="add-redis-cache-for-slow-active-record-queries">Add Redis cache for slow Active Record queries</h2>

<p>Database level optimization techniques have its limits. Once your data set grows large and business logic obliges you to fetch data from a couple of joined tables it might be difficult to achieve desired performance in an SQL database without resorting to caching.</p>

<p>If you are using Sidekiq in your project then you have Redis database already there. It is much simpler to use an existing infrastructure than having to add yet another dependency (e.g. <code class="highlighter-rouge">Memcached</code>). Redis provides a straightforward API for key-value storage. You don’t need to add any special gems to use it as your cache.</p>

<p>If Heroku is your hosting provider, then <a href="https://elements.heroku.com/addons/redistogo">Redis to Go</a> is what you are probably using. Enabling direct access to Redis, in that case, is as simple as adding one file:</p>

<p><code class="highlighter-rouge">config/initializers/redis.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="nb">require</span> <span class="s1">'redis'</span>

  <span class="vg">$redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"REDISTOGO_URL"</span><span class="p">))</span></code></pre></figure>

<p>I am using <a href="https://github.com/ondrejbartas/sidekiq-cron" target="_blank">Sidekiq Cron</a> to update my cache entry every half an hour:</p>

<p><code class="highlighter-rouge">app/jobs/cache_updater_job.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CacheUpdaterJob</span>
  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>
  <span class="n">sidekiq_options</span> <span class="ss">queue: </span><span class="s1">'default'</span>

  <span class="k">def</span> <span class="nf">perform</span>
    <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">current_promotions</span><span class="p">(</span>
      <span class="no">Product</span><span class="o">::</span><span class="no">GOOD_DISCOUNT</span>
    <span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
      <span class="no">Product</span><span class="o">::</span><span class="no">Serializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">to_json</span>
    <span class="k">end</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">products: </span><span class="n">products</span> <span class="p">}.</span><span class="nf">to_json</span>
    <span class="vg">$redis</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
      <span class="no">Product</span><span class="o">::</span><span class="no">PROMOTIONS_CACHE_KEY</span><span class="p">,</span>
      <span class="n">json_data</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p><code class="highlighter-rouge">config/schedule.yml</code></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">update_promotions_cache</span><span class="pi">:</span>
   <span class="na">cron</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*/30</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*"</span>
   <span class="na">class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CacheUpdaterJob"</span></code></pre></figure>

<p>Updating cache every 30 minutes works for my app’s case. Even if you need to serve your clients an almost live data, updating the cache every couple of seconds could still be more performant then fetching it from a database for every request.</p>

<p>Here’s how a Rails controller returning a cached response for the request without <code class="highlighter-rouge">discounted_by</code> param looks like:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">API</span><span class="o">::</span><span class="no">PromotionsController</span> <span class="o">&lt;</span> <span class="no">API</span><span class="o">::</span><span class="no">BaseController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="k">if</span> <span class="n">discounted_by</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:discounted_by</span><span class="p">]</span>
      <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">current_promotions</span><span class="p">(</span><span class="n">discounted_by</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
        <span class="no">Product</span><span class="o">::</span><span class="no">Serializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">to_json</span>
      <span class="k">end</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">products: </span><span class="n">products</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=</span> <span class="s2">"application/json"</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">response_body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="vg">$redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="no">Product</span><span class="o">::</span><span class="no">PROMOTIONS_CACHE_KEY</span><span class="p">)</span> <span class="o">||</span> <span class="s2">""</span>
      <span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>This version is ~5 times faster than the base one:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Transactions:              27002 hits
Availability:             100.00 %
Elapsed time:              59.30 secs
Data transferred:        4271.65 MB
Response time:              0.04 secs
Transaction rate:         455.35 trans/sec
Throughput:                72.03 MB/sec
Concurrency:               19.96
Successful transactions:   27002
Failed transactions:           0
Longest transaction:        1.21
Shortest transaction:       0.00</code></pre></figure>

<p>Not only it eliminates a need for a database query but also reduces memory usage because you don’t need to instantiate Active Record objects. Depending on your data size even JSON serialization itself could be a severe performance overhead.</p>

<p>You can also check out my other blog post for more tips on how to <a href="https://pawelurbanek.com/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku/">reduce memory usage in Rails apps</a>.</p>

<h2 id="optimize-rails-with-rack-middleware">Optimize Rails with Rack middleware</h2>

<p>Each request has to pass through all of the following Rails middlewares before it hits your application’s code:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Static</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Executor</span>
<span class="n">use</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Cache</span><span class="o">::</span><span class="no">Strategy</span><span class="o">::</span><span class="no">LocalCache</span><span class="o">::</span><span class="no">Middleware</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Runtime</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">MethodOverride</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">RequestId</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">RemoteIp</span>
<span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Logger</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ShowExceptions</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">DebugExceptions</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Callbacks</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Cookies</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">CookieStore</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Head</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ConditionalGet</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ETag</span></code></pre></figure>

<p>You can shave off a couple of milliseconds by bypassing the default stack and sending a response to client straight from your custom Rack middleware. You can do it by adding the following Rack app:</p>

<p><code class="highlighter-rouge">lib/cache_middleware.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CacheMiddleware</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s2">"/api/promotions.json"</span>
    <span class="n">no_param</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s2">"discounted_by"</span><span class="p">]</span> <span class="o">==</span> <span class="kp">nil</span>

    <span class="k">if</span> <span class="n">cache_path</span> <span class="o">&amp;&amp;</span> <span class="n">no_param</span>
      <span class="p">[</span>
        <span class="mi">200</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span><span class="p">},</span>
        <span class="p">[</span><span class="vg">$redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="no">Product</span><span class="o">::</span><span class="no">PROMOTIONS_CACHE_KEY</span><span class="p">)</span> <span class="o">||</span> <span class="s2">""</span><span class="p">]</span>
      <span class="p">]</span>
    <span class="k">else</span>
      <span class="vi">@app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>and configuring your Rails app to insert in at the beginning of its middleware stack:</p>

<p><code class="highlighter-rouge">config/environments/production.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">CacheMiddleware</span></code></pre></figure>

<p>It checks if a request is supposed to hit your optimized endpoint and has no value for an optional param. If that is the case it returns the cached JSON to the client, if not it passes the request to the next middleware in the stack.</p>

<p>This method is a bit extreme. It makes sense to use it only if you are experiencing a very heavy load. It also disables most of the tools which Rails provide out of the box, like cookies, session management or logging. Anyway, depending on your use case those couple of milliseconds saved could translate into serious hosting costs reduction.</p>

<p>These are detailed results of benchmarks when using a custom middleware. It’s  ~20% improvement compared to <em>“cache only”</em> version:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Transactions:               32782 hits
Availability:              100.00 %
Elapsed time:               59.94 secs
Data transferred:         5186.03 MB
Response time:               0.01 secs
Transaction rate:          546.91 trans/sec
Throughput:                 86.52 MB/sec
Concurrency:                 19.97
Successful transactions:     32782
Failed transactions:             0
Longest transaction:          0.16
Shortest transaction:         0.00</code></pre></figure>

<h2 id="final-remarks">Final remarks</h2>

<p>To keep things simple I did not cover any of the more advanced techniques like automatic cache invalidation or using a built-in Rails cache support. Check out <a href="https://github.com/redis-store/redis-rails" target="_blank">redis-rails</a> gem and <a href="http://guides.rubyonrails.org/caching_with_rails.html" target="_blank">official guides</a> if you are interested in that. Please remember that benchmarks were conducted on a local machine so they don’t take networking overhead into account. 500% gain is what I managed to achieve in application-specific code.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/02/05/optimize-rails-performance-bottleneck-with-caching-and-rack-middleware/</guid>
                <description>
                    
                    According to (a bit exaggerated) Pareto principle, 5% of your Rails app endpoints could account for 95% of performance issues. In this blog post I will describe how I improved a performance of my Rails application’s bottleneck endpoint by over 500% using a simple Redis caching technique and a custom Rack middleware.
                    
                </description>
                <pubDate>Mon, 05 Feb 2018 10:00:55 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Simple SSL Proxy for Insecure Browser Content with Ruby or NGINX</title>
                <link>https://pawelurbanek.com/2018/01/29/setup-ssl-proxy-for-insecure-browser-content-with-ruby-and-nginx/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Lock represents a secure SSL certificate" src="/assets/ssl-certificate-lock-3d84ed9f9cc18d8f0384e029142efe93e15d39ac08ae08e69d063573510c21c1.jpg" /></p>

<p>SSL protection is becoming de facto standard in web and mobile development. One potential problem is that website could be served via a secure SSL connection and still displayed as insecure by most of the modern browsers. It’s enough that at least one of its resources is served without SSL. In this blog post, I will explain how to setup Ruby and NGINX server to work as an SSL proxy for insecure content and describe some basic streaming techniques.</p>

<p><img class="center-image" alt="Insecure browser content warning in URL bar" src="/assets/insecure-browser-content-alert1-46d14256a8c9b097e9c261ce2fa4ebcdef811f48eb141a70603f987878190363.png" /></p>

<p><img class="center-image" alt="Insecure browser content warning in developer console" src="/assets/insecure-browser-content-alert2-27444ef96123d6f54b6eaf32658296e8277af1eb161b1c3dc5a036f74c6ec011.png" />
<span class="annotation">Developer console and URL bar display insecure content warnings on <a class="link-grey" href="https://wishlist.apki.io" target="_blank"> https://wishlist.apki.io</a>.</span></p>

<p>Until recently iTunes Store pages were displayed as insecure in the browsers because of <code class="highlighter-rouge">http</code> image assets. At the time of writing this blog post, iTunes API does not officially<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> provide image assets via SSL.</p>

<p>You can check yourself:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"open-uri"</span>
<span class="nb">require</span> <span class="s2">"json"</span>

<span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"https://itunes.apple.com/lookup?id=1201642309"</span><span class="p">).</span><span class="nf">read</span><span class="p">)[</span><span class="s2">"results"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"screenshotUrls"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="o">=&gt;</span> <span class="s2">"http://is4.mzstatic.com/image/thumb/Purple128/v4/50/b6/59/50b65977-5605-4cf3-eee6-6ff350a9c9c4/source/406x228bb.jpg"</span></code></pre></figure>

<p>If you want to display this kind of insecure asset<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> on your webpage without browser warnings, here’s what you can do:</p>

<h2 id="download-assets-and-serve-them-via-amazon-s3">Download assets and serve them via Amazon S3</h2>

<p>You could download all the required assets to deliver them via a secure connection. In this case <a href="https://aws.amazon.com/s3/" target="_blank">Amazon S3</a> with <a href="https://aws.amazon.com/cloudfront/" target="_blank">CloudFront</a> could serve you well. An advantage of this approach is that traffic does not go through your servers, and assets can be cached using CloudFront CDN. Unfortunately, you have to take care of updating assets yourself (app icons could change at any time), and pay for all the bandwidth.</p>

<h2 id="down-gem-for-streaming-support">“down” gem for streaming support</h2>

<p>Each of the following examples uses <a href="https://github.com/janko-m/down" target="_blank">down gem</a>. It provides a simple API for working with file downloads and supports more advanced techniques like streaming and caching. It also has a small memory footprint of less the <code class="highlighter-rouge">0.4 MB</code> on load.</p>

<h2 id="use-rails-app-as-an-ssl-proxy">Use Rails app as an SSL proxy</h2>

<p>Another solution would be to proxy an asset request through a Rails-based server. In that case, a Rails app downloads an asset and sends it to the browser via a secure connection. You would need to include an asset location as a parameter of the request. Here’s how a simple Rails controller implementation could look like:</p>

<p><code class="highlighter-rouge">app/config/routes.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="s2">"/"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"files#show"</span></code></pre></figure>

<p><code class="highlighter-rouge">app/controllers/files_controller.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"down"</span>

<span class="k">class</span> <span class="nc">FilesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="no">Down</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:target</span><span class="p">))</span>
    <span class="n">send_data</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">read</span><span class="p">,</span> <span class="ss">type: </span><span class="n">data_source</span><span class="p">.</span><span class="nf">content_type</span><span class="p">,</span> <span class="ss">disposition: </span><span class="s2">"inline"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Then you could access the asset using the following URL:</p>

<p><code class="highlighter-rouge">https://yourapp.com?target=http://is4.mzstatic.com/image/thumb/Purple128/v4/50/b6/59/50b65977-5605-4cf3-eee6-6ff350a9c9c4/source/406x228bb.jpg</code></p>

<h3 id="streaming-for-large-assets">Streaming for large assets</h3>

<p>When dealing with a larger asset a better idea would be to stream it to client part by part. To do it you need to assign an object responding to <code class="highlighter-rouge">each</code> method to <code class="highlighter-rouge">response_body</code> controller property:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"down"</span>

<span class="k">class</span> <span class="nc">FilesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="no">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">128</span> <span class="c1"># 128 KB</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="no">Down</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:target</span><span class="p">))</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:headers</span><span class="p">).</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">response_body</span> <span class="o">=</span> <span class="no">Enumerator</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">body</span><span class="o">|</span>
      <span class="k">while</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">eof?</span> <span class="o">==</span> <span class="kp">false</span>
        <span class="n">body</span> <span class="o">&lt;&lt;</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">CHUNK_SIZE</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">data_source</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>An advantage of this approach is that in case of large assets, they would not need to be instantiated into memory all at once. It’s an equivalent of using <code class="highlighter-rouge">File.readlines</code> instead of <code class="highlighter-rouge">File.read</code> when working with files. Depending on your use case you could play around with <code class="highlighter-rouge">CHUNK_SIZE</code> constant value.</p>

<p>You can also check out my other blog post for more tips on how to <a href="https://pawelurbanek.com/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku/">reduce memory usage in Rails apps</a>.</p>

<h2 id="use-ruby-rack-app-as-an-ssl-proxy">Use Ruby Rack app as an SSL proxy</h2>

<p>You could improve performance by dropping Rails altogether and using a barebones Rack app to serve the asset. Here’s a basic Rack server implementation:</p>

<p><code class="highlighter-rouge">config.ru</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"down"</span>

<span class="n">run</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
  <span class="n">req</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="n">data_source</span> <span class="o">=</span> <span class="no">Down</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"target"</span><span class="p">))</span>
  <span class="p">[</span>
    <span class="mi">200</span><span class="p">,</span>
     <span class="p">{</span>
       <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">content_type</span><span class="p">,</span>
       <span class="s2">"Content-Length"</span> <span class="o">=&gt;</span> <span class="n">data_source</span><span class="p">.</span><span class="nf">size</span><span class="p">,</span>
     <span class="p">},</span>
     <span class="p">[</span><span class="n">data_source</span><span class="p">.</span><span class="nf">read</span><span class="p">]</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p><span class="annotation">You can run Rack apps with a <i>rackup</i> command</span></p>

<h3 id="assets-streaming-with-rack">Assets streaming with Rack</h3>

<p>Here is how you could send an asset part by part using <code class="highlighter-rouge">Rack::Chunked</code> middleware:</p>

<p><code class="highlighter-rouge">config.ru</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"down"</span>

<span class="k">class</span> <span class="nc">App</span>
  <span class="no">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">128</span> <span class="c1"># 128 KB</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="vi">@data_source</span> <span class="o">=</span> <span class="no">Down</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"target"</span><span class="p">))</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:headers</span><span class="p">)</span>
    <span class="p">[</span>
      <span class="mi">200</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">headers</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">),</span>
        <span class="s2">"Content-Encoding"</span> <span class="o">=&gt;</span> <span class="s2">"Chunked"</span>
      <span class="p">},</span>
      <span class="nb">self</span>
    <span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">each</span>
    <span class="k">while</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">eof?</span> <span class="o">==</span> <span class="kp">false</span>
      <span class="k">yield</span> <span class="vi">@data_source</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">CHUNK_SIZE</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="vi">@data_source</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Chunked</span>
<span class="n">run</span> <span class="no">App</span><span class="p">.</span><span class="nf">new</span></code></pre></figure>

<h2 id="use-nginx-as-an-ssl-proxy">Use NGINX as an SSL proxy</h2>

<p>A different solution would be using an NGINX to proxy pass to an insecure assets. You can check out my <a href="/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/">previous blog post</a> for tips on how to configure NGINX with free SSL. If you are using Heroku as your hosting provider, you can setup NGINX as a reverse proxy in front of your Rails app using <a href="https://github.com/KazW/nginx-buildpack" target="_blank">a buildpack</a>.</p>

<p>Here’s a sample config:</p>

<figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
     <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
     <span class="kn">listen</span> <span class="mi">443</span><span class="p">;</span>
     <span class="kn">server_name</span> <span class="s">example-proxy.com</span><span class="p">;</span>

     <span class="kn">ssl</span>        <span class="no">on</span><span class="p">;</span>
     <span class="kn">ssl_certificate</span>         <span class="n">/etc/nginx/origin_cert.pem</span><span class="p">;</span>
     <span class="kn">ssl_certificate_key</span>     <span class="n">/etc/nginx/private_key.pem</span><span class="p">;</span>

     <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">resolver</span> <span class="mi">8</span><span class="s">.8.8.8</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="nv">$arg_target</span><span class="p">;</span>
     <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">resolver 8.8.8.8;</code> line is needed to dynamically resolve DNS config of a target asset server and enable support for different assets hosts. An advantage of this solution is that you don’t block your Ruby process and NGINX is better suited to handle multiple concurrent clients than Ruby servers.</p>

<h2 id="summary">Summary</h2>

<p>I’ve been using the NGINX based solution in <a href="https://wishlist.apki.io/" target="_blank">Smart Wishlist</a> for quite a while now to serve iTunes assets via SSL to both React based frontend and iOS apps. Remember that if your project has a lot of traffic, you would need to watch out for problems with rate limiting by your assets API provider. You could also use these techniques to proxy pass any other kind of static assets, not only images.</p>

<p>Hope those tips can help you offload some of the work from your servers. Doing an SSL proxy pass is quicker and cheaper to implement than downloading the assets and hosting them yourself.</p>

<p><strong>Disclaimer:</strong> As pointed out in the comments, these examples do not include any restrictions on how and which assets can be accessed. In theory bad guys could start piggybacking on a proxy configured like this. You should consider IP, host or asset type based whitelist to make it more secure.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>iTunes API assets are available through SSL via an undocumented URL: <code class="highlighter-rouge">http://is4-ssl.mzstatic.com/image/thumb/Purple128/v4/50/b6/59/50b65977-5605-4cf3-eee6-6ff350a9c9c4/source/406x228bb.jpg</code> but it could change at any time. Hopefully, Apple will migrate all of iTunes API to SSL only soon. Point of this blog post is to show what you could do if SSL version of the asset was not available at all. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>A screenshot comes for an <a href="https://itunes.apple.com/us/app/playdeads-inside/id1201642309?mt=8" target="_blank">INSIDE</a> game. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/29/setup-ssl-proxy-for-insecure-browser-content-with-ruby-and-nginx/</guid>
                <description>
                    
                    SSL protection is becoming de facto standard in web and mobile development. One potential problem is that website could be served via a secure SSL connection and still displayed as insecure by most of the modern browsers. It's enough that at least one of its resources is served without SSL. In this blog post, I will explain how to setup a simple Ruby and NGINX server to work as an SSL proxy for insecure content and describe some basic streaming techniques.
                    
                </description>
                <pubDate>Mon, 29 Jan 2018 10:10:00 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Multiple Domains with Free Wildcard SSL from Cloudflare</title>
                <link>https://pawelurbanek.com/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Multiple http domains can be cheap" src="/assets/signs-bfb1f5fc4b30c1d171fa529dd9a39097eeaf23a1e1ade991de7f9089abba4cb4.jpg" /></p>

<p>Domain names you own could be your most expensive to do list. What’s more a domain without a valid SSL will show up in all modern browsers as an insecure content. In this blog post, I will explain how to minimize the cost of owning multiple wildcard SSL-protected domains using Cloudflare and set them up with Github Pages, Heroku or NGINX.</p>

<p>After I did not renew yet another domain for one of my <em>not-so-profitable-yet</em> side projects I decided to change a strategy. Now I am hosting most of my projects on subdomains of one root domain: <a href="https://apki.io" target="_blank">apki.io</a>. I’ve used it for a couple of projects so far:</p>

<p><a href="https://abot.apki.io" target="_blank">https://abot.apki.io</a></p>

<p><a href="https://wishlist.apki.io" target="_blank">https://wishlist.apki.io</a></p>

<p><a href="https://selfcontrol.apki.io" target="_blank">https://selfcontrol.apki.io</a></p>

<p><a href="https://focus.apki.io/" target="_blank">https://focus.apki.io</a></p>

<p><a href="https://tracky.apki.io/" target="_blank">https://tracky.apki.io</a></p>

<p>My only cost is the yearly renewal of the root domain. Each of these sites has a grade A SSL which works in all the browsers. Here’s how you can do it:</p>

<h2 id="buy-a-root-domain">Buy a “root” domain</h2>

<p>I usually use <a href="https://www.gandi.net/" target="_blank">Gandi</a> but it does not really matter which provider you choose. There are plenty of tutorials explaining how to buy a domain so I will not elaborate on that.</p>

<h2 id="setup-cloudflare-and-free-ssl-certificate">Setup Cloudflare and free SSL certificate</h2>

<p><a href="https://www.cloudflare.com/" target="_blank">Cloudflare</a> is a great service providing tons of features ranging from DDOS protection to smart caching and more. We will focus on how to use it to configure free SSL.</p>

<p>First, you need to move your domain’s nameservers to Cloudflare. After adding a domain to your Cloudflare panel you will be able to check if new config has already propagated. Keep in mind that it can take up to 24 hours.</p>

<p>Next, you need to issue a Cloudflare SSL certificate for your domain. They provide a free wildcard certificate. You can do it in a <code class="highlighter-rouge">Crypto</code> tab bar:</p>

<p><img class="center-image" alt="Cloudflare free wildcard SSL was issued" src="/assets/cloudflare_ssl-40256cd99a4efcb0ffe9677df08a69fb159cc2e2507c5029dbd3a703ebb77277.png" /></p>

<p><span class="annotation">In case that after 24 hours they are still “Authorizing Certificate” you should contact support.</span></p>

<h2 id="setup-github-pages">Setup Github Pages</h2>

<p><a href="https://pages.github.com/" target="_blank">Github Pages</a> is a popular solution for hosting static pages. This blog itself is placed there and powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>. It is free as long as you are using a public GitHub repo. Out of the box, it provides an <code class="highlighter-rouge">https://[Your username].github.io</code> domain for you, however with a minimal configuration you can setup your own domain for free.</p>

<p>First, you need to change your DNS config to point to GitHub’s IP (<code class="highlighter-rouge">192.30.252.154</code>) using an A record. You can do it in Cloudflare DNS settings:</p>

<p><img class="center-image" alt="DNS A config in Cloudflare panel" src="/assets/dns_a_config-25e0e85cda78fc35a3e0b2fd081b6c92f922c9c4773b0d8de18dd41d38de18b0.png" /></p>

<p>then in your project settings on GitHub, you should add a custom domain name:</p>

<p><img class="center-image" alt="GitHub settings, setup custom domain with no cost SSL" src="/assets/github_settings-a5d06af41dcea16bb5d38de48180ff7d164f3ade32aad1582dfcc74beccaee89.png" /></p>

<p>That’s it, your website should be up running.</p>

<h2 id="setup-heroku">Setup Heroku</h2>

<p>If you need something more complex than a static page then <a href="https://heroku.com/" target="_blank">Heroku</a> could be a thing for you. By default, it offers an <code class="highlighter-rouge">https://[Your app name].herokuapp.com</code> domain. Same as with GitHub pages you can hook your own domain with SSL without any additional costs.</p>

<p>Start with adding your domain name in Heroku’s app settings:</p>

<p><img class="center-image" alt="Heroku settings, setup custom domain with free SSL" src="/assets/heroku_domain-8bc1696ee1bb65057ba42134a0aeb1d6db380438c4b535a586f9de3b9b55fb6e.png" />
<span class="annotation">Don’t worry about those error messages, it works anyway</span></p>

<p>Then add a CNAME record pointing your subdomain to default Heroku URL in your Cloudflare DNS dashboard:</p>

<p><img class="center-image" alt="Cloudflare CNAME DNS setting" src="/assets/dns_cname-b7b3a6920efccabd626557a3d4fa897c1c696bb4dbb773950fbc1e542156a2f8.png" />
<span class="annotation">Add a CNAME record pointing subdomain to https://[Your app name].herokuapp.com</span></p>

<p>Your Heroku app should now be available on your custom domain with full SSL support.</p>

<h2 id="setup-nginx">Setup NGINX</h2>

<p>If you are using a custom hosting infrastructure then <a href="https://nginx.org/en/" target="_blank">NGINX</a> could be your front-end server. In this case you can still hook free SSL with a custom domain.</p>

<p>Start with pointing your domain to your server’s IP using an A DNS record. Next, check out two detailed articles on Cloudflare support explaining how to complete the setup:</p>

<p><a href="https://support.cloudflare.com/hc/en-us/articles/115000479507" target="_blank">Creating and managing certificates with Origin CA</a></p>

<p><a href="https://support.cloudflare.com/hc/en-us/articles/217471977" target="_blank">How to install an Origin CA certificate in NGINX</a></p>

<h2 id="final-remarks">Final remarks</h2>

<p>Keep in mind that when working with DNS and SSL configuration you probably will run into some caching related issues. I usually use <a href="https://www.whatsmydns.net/" target="_blank">DNS Propagation Checker</a> to see if changes have already been applied. Still, some of the settings could be cached locally on your computer. On macOS running these commands could help:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>killall <span class="nt">-HUP</span> mDNSResponder
<span class="nb">sudo </span>killall mDNSResponderHelper
<span class="nb">sudo </span>dscacheutil <span class="nt">-flushcache</span></code></pre></figure>

<p>If not then you could check if it works on different browsers or your mobile device. Rule of the thumb, if it should work but it still doesn’t I just leave it for a couple of hours and then check again ¯\<em>(ツ)</em>/¯.</p>

<p>There’s also <a href="https://letsencrypt.org/" target="_blank">Let’s Encrypt</a> you can use to setup free SSL. So far Cloudflare has always been good enough for what I needed.</p>

<p>Obviously, you can use all of those tips for top-level domains as well. Hope it helps you shave a few bucks off what you spend on your online projects.</p>

<p><strong>Disclaimer:</strong> I’m not a web security expert. I would not recommend using these tips for a project with bank-level security requirements. Let me know in the comments if you notice some security loopholes in those settings.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare/</guid>
                <description>
                    
                    Domain names you own could be your most expensive to do list. What’s more a domain without a valid SSL will show up in all modern browsers as an insecure content. In this blog post, I will explain how to minimize the cost of owning multiple wildcard SSL-protected domains using Cloudflare and set them up with Github Pages, Heroku or NGINX.
                    
                </description>
                <pubDate>Mon, 22 Jan 2018 10:00:00 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Reduce Rails Memory Usage, Fix R14 and Save Money on Heroku</title>
                <link>https://pawelurbanek.com/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Reduce costs on Heroku, represented by a pig image" src="/assets/pig-represents-saving-money-on-heroku-2d7543382abaf45f25c54acb474d389536034d92a759e0317178e6d1f3ac2f15.jpg" /></p>

<p>In theory, you can run both Rails web server and Sidekiq process on one 512mb Heroku dyno. For side projects with small traffic, saving $7/month always comes in handy. Unfortunately when trying to fit two Ruby processes on one dyno you can run into memory issues. In this post, I will explain how you can reduce memory usage in Rails apps.</p>

<p>Recently, I read a <a href="https://bilalbudhani.com/running-sidekiq-on-heroku-free-dyno/" target="_blank">great article</a> by Bilal Budhani explaining how to run Sidekiq process alongside Puma on one Heroku dyno. After applying it to <a href="https://wishlist.apki.io" target="_blank">one of my side projects</a>, I started running into those dreaded R14 errors.</p>

<p><img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby errors" src="/assets/R14_error-26587125dc2d34675e70602c79431a4e9f415953276fdeff86bfcf88bb1c3c36.png" /></p>

<p><span class="annotation">Memory usage spiked followed by a bunch of memory errors and automatic restart</span></p>

<p>I did some digging and, after a couple of optimizations memory usage charts started looking like this:</p>

<p><img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby fixed" src="/assets/R14_fixed-2f03942be78002ee38a8e10aa0ce798d8e4d0dd883b3c41ac23084ce5dbd37b2.png" /></p>

<p><span class="annotation">Stable memory usage followed by garbage collection</span></p>

<p>Here’s what I did:</p>

<h2 id="put-your-gemfile-on-a-diet">Put your Gemfile on a diet</h2>

<p><em>There is a Gem for that…</em> In the Ruby world, dropping in a Gem to solve a problem is usually the <em>“easiest”</em> solution. Apart from other costs, memory bloat is one that can easily get overlooked.</p>

<p>The best way to check how much memory each of your gems consumes is to use <a href="https://github.com/schneems/derailed_benchmarks" target="_blank">derailed benchmarks</a>. Just add:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'derailed_benchmarks'</span><span class="p">,</span> <span class="ss">group: :development</span></code></pre></figure>

<p>to your <code class="highlighter-rouge">Gemfile</code> and run <code class="highlighter-rouge">bundle exec derailed bundle:mem</code>.</p>

<p>My project powers <a href="https://twitter.com/apps_wishlist" target="_blank">Twitter</a> and <a href="https://www.facebook.com/SmartWishlistiOS/" target="_blank">Facebook</a> bot profiles. I was surprised to find out that a popular <a href="https://github.com/sferik/twitter" class="link" target="_blank">twitter</a> gem uses over <code class="highlighter-rouge">13 MB</code> of memory on startup. First I replaced it with its lightweight alternative <a href="https://github.com/hayesdavis/grackle" target="_blank">grackle</a> (<code class="highlighter-rouge">~1 MB</code>) and finally ended up writing a custom code making a HTTP call to Twitter API. I also managed to get rid of <a href="https://github.com/arsduo/koala" target="_blank">koala</a> gem (<code class="highlighter-rouge">~2 MB</code>) in the same way.</p>

<p>Another quick win was replacing <a href="https://github.com/gazay/gon" target="_blank">gon</a> gem (<code class="highlighter-rouge">~6 MB</code>) with custom JavaScript data attributes.</p>

<p>Importing a couple of MBs worth of gem files to simplify making one HTTP call or preventing writing a couple of JavaScript lines should definitely be avoided.</p>

<h2 id="use-jemalloc-to-reduce-rails-memory-usage">Use jemalloc to reduce Rails memory usage</h2>

<p><a href="http://jemalloc.net/">jemalloc</a> is an alternative to official MRI memory allocator. On Heroku, you can add jemalloc using a <a href="https://github.com/gaffneyc/heroku-buildpack-jemalloc" class="link" target="_blank">buildpack</a>. For my app, it resulted in ~20% memory usage decrease. Just make sure to test your app with jemalloc thoroughly on a staging environment before deploying it to production.</p>

<h2 id="limit-concurrency-and-workers">Limit concurrency and workers</h2>

<p>For a side project with limited traffic you probably don’t need a lot of throughput anyway. You can limit memory usage by reducing Sidekiq and Puma workers and threads count. Here’s my <code class="highlighter-rouge">config/puma.rb</code> file:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">threads_count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">threads</span> <span class="n">threads_count</span><span class="p">,</span> <span class="n">threads_count</span>
<span class="n">port</span>        <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"PORT"</span><span class="p">)</span> <span class="p">{</span> <span class="mi">3000</span> <span class="p">}</span>
<span class="n">environment</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"RAILS_ENV"</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"production"</span> <span class="p">}</span>
<span class="n">workers</span> <span class="mi">1</span>

<span class="n">preload_app!</span>

<span class="n">on_worker_boot</span> <span class="k">do</span>
  <span class="vi">@sidekiq_pid</span> <span class="o">||=</span> <span class="n">spawn</span><span class="p">(</span><span class="s1">'bundle exec sidekiq -t 1'</span><span class="p">)</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">on_restart</span> <span class="k">do</span>
  <span class="no">Sidekiq</span><span class="p">.</span><span class="nf">redis</span><span class="p">.</span><span class="nf">shutdown</span> <span class="p">{</span> <span class="o">|</span><span class="n">conn</span><span class="o">|</span> <span class="n">conn</span><span class="p">.</span><span class="nf">close</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">plugin</span> <span class="ss">:tmp_restart</span></code></pre></figure>

<p>and <code class="highlighter-rouge">config/sidekiq.yml</code>:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="nn">---</span>
<span class="s">:concurrency</span><span class="pi">:</span> <span class="s">1</span>
<span class="s">:queues</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">default</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">critical</span><span class="pi">,</span> <span class="nv">100</span><span class="pi">]</span></code></pre></figure>

<p>Although we specify 1 as the max number of threads, Puma can <a href="https://github.com/puma/puma#thread-pool" target="_blank">spawn up to 7 threads</a>. With those minimal settings, <a href="http://wishlist.apki.io/" target="_blank">Smart Wishlist</a> is still able to process around 100k Sidekiq jobs daily and serve both React frontend and mobile JSON API.</p>

<h2 id="optimize-json-parsing">Optimize JSON parsing</h2>

<p>All those Sidekiq jobs are necessary to download up to date prices from iTunes API (requests batching is on my TODO list) and send push notifications about discounts. This means there’s quite a lot of JSON parsing going on there. There is an oneline fix which can help optimize both memory usage and performance in such cases:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'yajl-ruby'</span><span class="p">,</span> <span class="ss">require: </span><span class="s1">'yajl/json_gem'</span></code></pre></figure>

<p><a href="https://github.com/brianmario/yajl-ruby" target="_blank">yaji-ruby</a> offers a JSON gem Compatibility API, which hooks into <code class="highlighter-rouge">JSON.parse</code> calls, improving their performance and memory usage.</p>

<h2 id="summary">Summary</h2>

<p>Working in constrained environments is a great way to flex your programming muscles and discover new optimization techniques. In theory, you could always solve memory issues by throwing more money at your servers, but why not keep those $7 instead?</p>

<p>Check out my other blog post for more tips on how to <a href="https://pawelurbanek.com/2018/02/05/optimize-rails-performance-bottleneck-with-caching-and-rack-middleware/">improve performance and reduce memory usage of Rails apps</a>.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku/</guid>
                <description>
                    
                    In theory, you can run both Rails web server and Sidekiq process on one 512mb Heroku dyno. For side projects with small traffic, saving $7/month always comes in handy. Unfortunately when trying to fit two Ruby processes on one dyno you can run into memory issues. In this post, I will explain how you can limit memory usage in Rails apps.
                    
                </description>
                <pubDate>Mon, 15 Jan 2018 10:00:25 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
        
            <item>
                <title>Productive Laziness - Optimize your Shell Workflow</title>
                <link>https://pawelurbanek.com/2018/01/08/productive-laziness-optimize-your-shell-workflow/</link>
                <content:encoded>
                    <![CDATA[
                    <p><img class="center-image post-main-image" alt="Lazy sleeping cat" src="/assets/lazy-cat-961c27ad84e61e63fe0e643e5394860714b4acea60c9a5ba1791d8704d9660ea.jpg" /></p>

<p>I would like to share a simple productivity tip that probably helped me save thousands of keystrokes so far.</p>

<p>I’ve been using this technique for a while now to maximize my laziness (<em>productivity</em>) during work and so, recently I wrapped it up in an easy to use <a href="https://github.com/pawurb/lazyme" class="link" target="_blank">Ruby Gem</a>. It simply counts your shell commands and displays them sorted by usage frequency. Using it is as simple as typing:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gem <span class="nb">install </span>lazyme
lazyme</code></pre></figure>

<p>This is how my most used commands look now. Top hits are usually a good candidate for new aliases:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">+---------------------------------------------+-------+
|                     Lazyme                          |
+---------------------------------------------+-------+
|...                                          | ...   |
| ei                                          | 21    |
| gpstg                                       | 22    |
| gstp                                        | 23    |
| zs                                          | 28    |
| s .                                         | 30    |
| zrr                                         | 32    |
| gpshh                                       | 60    |
| rss                                         | 70    |
| c                                           | 75    |
| gd                                          | 107   |
| o .                                         | 123   |
| gst                                         | 130   |
| ls                                          | 179   |
| gl                                          | 310   |
| gp                                          | 445   |
| gds                                         | 540   |
| gaa                                         | 817   |
| g                                           | 3365  |
+---------------------------------------------+-------+
| Command                                     | Count |
+---------------------------------------------+-------+</code></pre></figure>

<p>With almost all top commands being aliases, I am now sure I work as lazily as possible.</p>

<p>I know that some developers don’t like using aliases because they worry that they might keep forgetting them. To fix this problem, I have a special alias <code class="highlighter-rouge">aliases</code> which displays a list of all my aliases (btw <code class="highlighter-rouge">gr</code> is an alias for <code class="highlighter-rouge">grep</code>).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">aliases | gr aliases
<span class="o">=&gt;</span> <span class="nb">alias</span> <span class="s1">'aliases'</span><span class="o">=</span><span class="s1">'cat ~/.dotfiles/settings/shell/aliases.sh'</span></code></pre></figure>

<p>Some say that if you get used to using aliases too much you might have a problem with working efficiently on remote servers which lack your custom config settings. I solved this problem with a couple of aliases which upload a list of my most essential aliases to remote servers (<code class="highlighter-rouge">ubash</code>, <code class="highlighter-rouge">uvim</code> and <code class="highlighter-rouge">ugit</code>). Just be careful not to overwrite some important settings if you don’t own the server. Whether you want to sacrifice your productivity when working locally, to avoid some possible problems when working on remote server is entirely up to you.</p>

<p>You can set aliases and helper functions by adding following lines into your <code class="highlighter-rouge">.bashrc</code> or <code class="highlighter-rouge">.zshrc</code> files:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">gr</span><span class="o">=</span><span class="s1">'grep — color'</span>
<span class="nb">alias </span><span class="nv">g</span><span class="o">=</span><span class="s1">'git status'</span>
<span class="nb">alias </span><span class="nv">gaa</span><span class="o">=</span><span class="s1">'git add . -A'</span>

<span class="k">function </span>gm<span class="o">()</span> <span class="o">{</span>
  git commit <span class="nt">-m</span> <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span>
<span class="o">}</span></code></pre></figure>

<p>I, therefore, encourage you to show your fingers some love and treat them to a couple of nice aliases.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/08/productive-laziness-optimize-your-shell-workflow/</guid>
                <description>
                    
                    I would like to share a simple productivity tip that probably helped me save thousands of keystrokes so far. I’ve been using this technique for a while now to maximize my laziness (productivity) during work and so, recently I wrapped it up in an easy to use Ruby Gem.
                    
                </description>
                <pubDate>Mon, 08 Jan 2018 16:26:52 +0100</pubDate>
                <author>Paweł Urbanek</author>
            </item>
        
    
  </channel>
</rss>
