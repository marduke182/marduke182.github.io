<!doctype html>
<html amp lang="en">
  <head>
    <meta charset="utf-8">
    <title>Reduce Rails Memory Usage, Fix R14 and Save Money on Heroku</title>
    <link rel="canonical" href="https://pawelurbanek.com/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet'>
    <style amp-custom>
       /** Syntax highlighting styles */
.highlight { background: #fff; }
.highlighter-rouge .highlight { background: #eef; }
.highlight .c { color: #998; font-style: italic; }
.highlight .err { color: #a61717; background-color: #e3d2d2; }
.highlight .k { font-weight: bold; }
.highlight .o { font-weight: bold; }
.highlight .cm { color: #998; font-style: italic; }
.highlight .cp { color: #999; font-weight: bold; }
.highlight .c1 { color: #998; font-style: italic; }
.highlight .cs { color: #999; font-weight: bold; font-style: italic; }
.highlight .gd { color: #000; background-color: #fdd; }
.highlight .gd .x { color: #000; background-color: #faa; }
.highlight .ge { font-style: italic; }
.highlight .gr { color: #a00; }
.highlight .gh { color: #999; }
.highlight .gi { color: #000; background-color: #dfd; }
.highlight .gi .x { color: #000; background-color: #afa; }
.highlight .go { color: #888; }
.highlight .gp { color: #555; }
.highlight .gs { font-weight: bold; }
.highlight .gu { color: #aaa; }
.highlight .gt { color: #a00; }
.highlight .kc { font-weight: bold; }
.highlight .kd { font-weight: bold; }
.highlight .kp { font-weight: bold; }
.highlight .kr { font-weight: bold; }
.highlight .kt { color: #458; font-weight: bold; }
.highlight .m { color: #099; }
.highlight .s { color: #d14; }
.highlight .na { color: #008080; }
.highlight .nb { color: #0086B3; }
.highlight .nc { color: #458; font-weight: bold; }
.highlight .no { color: #008080; }
.highlight .ni { color: #800080; }
.highlight .ne { color: #900; font-weight: bold; }
.highlight .nf { color: #900; font-weight: bold; }
.highlight .nn { color: #555; }
.highlight .nt { color: #000080; }
.highlight .nv { color: #008080; }
.highlight .ow { font-weight: bold; }
.highlight .w { color: #bbb; }
.highlight .mf { color: #099; }
.highlight .mh { color: #099; }
.highlight .mi { color: #099; }
.highlight .mo { color: #099; }
.highlight .sb { color: #d14; }
.highlight .sc { color: #d14; }
.highlight .sd { color: #d14; }
.highlight .s2 { color: #d14; }
.highlight .se { color: #d14; }
.highlight .sh { color: #d14; }
.highlight .si { color: #d14; }
.highlight .sx { color: #d14; }
.highlight .sr { color: #009926; }
.highlight .s1 { color: #d14; }
.highlight .ss { color: #990073; }
.highlight .bp { color: #999; }
.highlight .vc { color: #008080; }
.highlight .vg { color: #008080; }
.highlight .vi { color: #008080; }
.highlight .il { color: #099; }

.icon > svg { display: inline-block; width: 16px; height: 16px; vertical-align: middle; }
.icon > svg path { fill: #828282; }

amp-img { background-color: grey; }

.cf:after { content: ""; display: table; clear: both; }

main { display: block; }

body { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; margin: 0; padding: 0; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-font-feature-settings: "liga=1, dlig=1"; -ms-font-feature-settings: "liga", "dlig"; -webkit-font-feature-settings: "liga", "dlig"; -o-font-feature-settings: "liga", "dlig"; font-feature-settings: "liga", "dlig"; }

.site-header { position: relative; width: 100%; max-width: 700px; margin: 16px auto 0 auto; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .site-header { padding: 0 16px; } }
.site-header .page-links { display: block;  font-weight: 400; font-style: normal; font-size: 18px; line-height: 30px; }
.site-header .page-links a { text-decoration: none; }

.blog-header { width: 100%; max-width: 700px; margin: 0 auto; position: relative; padding: 0; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
.blog-header .blog-title { margin-bottom: 8px; font-size: 50px; font-weight: 700; letter-spacing: -2px; outline: 0; line-height: 50px; word-break: break-word; color: #333333; }
.blog-header .blog-description { font-size: 28px; margin: 0 0 20px; padding: 0; line-height: 1.2; color: #666666; font-weight: 300; }

.content { width: 100%; max-width: 700px; margin: 25px auto 0 auto; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .content { padding: 0 16px; } }
.content article { padding: 20px 0; border-bottom: 1px solid #f2f2f0; }
.content article:last-child { border-bottom: 0px; }
.content article .post-title { letter-spacing: -0.02em; font-weight: 700; font-style: normal; display: block; font-size: 36px; line-height: 1.15; margin: 0 0; }
.content article .post-title a { text-decoration: none; color: #333332; }
.content article .post-title a:hover { text-decoration: none; }
.content article .post-excerpt { letter-spacing: -0.02em; font-weight: 300; font-style: normal; font-size: 20px; line-height: 1.59; color: #666665; }
.content article .post-meta { font-size: 14px; color: #b3b3b1; line-height: 30px; }
.content article .post-meta a { color: #b3b3b1; text-decoration: none; }
.content article .post-meta a:hover { text-decoration: underline; }

.post-template .content { max-width: 700px; }

.index-headline { border-top: 1px solid #dededc; margin: 0; padding: 16px 0; }
.index-headline span { color: #b3b3b1; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

.pagination { text-align: center; padding: 16px 0 0; font-size: 12px; }
.pagination a { color: #999999; text-decoration: none; }
.pagination a:hover { color: #333333; }

.site-footer { margin: 0 auto; padding: 48px 0; width: 100%; max-width: 700px; font-size: 12px; text-align: center; color: #999999; line-height: 17.6px; }
.site-footer a { color: #666666; text-decoration: none; }
.site-footer a:hover { color: #333333; }

.post .post-meta { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-title { font-weight: 700; font-style: normal; letter-spacing: -0.04em; font-size: 50px; line-height: 1.1; color: #333332; margin-bottom: 50px; }
.post .author-image { background-image: url(/amplify//assets/images/author.jpg); display: inline-block; width: 30px; height: 30px; line-height: 30px; margin-right: 8px; margin-bottom: -10px; float: left; background-size: cover; border-radius: 100%; text-indent: -9999px; }
.post .post-meta-text { color: #b3b3b1; letter-spacing: -0.02em; font-weight: 400; font-style: normal; font-size: 14px; overflow: hidden; font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; white-space: nowrap; text-overflow: ellipsis; }
.post .post-content { width: 100%; font-family: "Merriweather",Georgia, Cambria, "Times New Roman", Times, "Lora", serif; color: #333333; }
.post .post-content h1, .post .post-content h2, .post .post-content h3 { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-content h3, .post .post-content h4, .post .post-content h5, .post .post-content h6 { letter-spacing: -0.02em; font-weight: 700; font-style: normal; font-size: 24px; line-height: 1.3; margin-top: 50px; margin-bottom: 0px; font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-content h3 { font-size: 36px; }
.post .post-content h2, .post .post-content h1 { letter-spacing: -0.02em; font-weight: 700; font-style: normal; font-size: 42px; line-height: 1.2; margin-top: 50px; margin-bottom: 0px; }
.post .post-content p { font-weight: 400; font-style: normal; font-size: 22px; line-height: 1.59; letter-spacing: -.002em; margin-top: 30px; margin-bottom: 0; color: #333333; -webkit-hyphens: auto; -moz-hyphens: auto; hyphens: auto; }
.post .post-content a { color: #333333; text-decoration: underline; }
.post .post-content amp-img, .post .post-content amp-youtube { margin-top: 30px; }
.post .post-content figure { margin: 0; padding: 0 0 30px; }
.post .post-content figcaption { font-weight: 400; font-style: italic; font-size: 16px; line-height: 1.3; color: #666665; outline: 0; z-index: 300; text-align: center; }
.post .post-content hr { border: 0; padding: 0; display: block; width: 15%; margin: 30px auto; border: 0px solid #dddddd; border-top: 1px solid #dddddd; }
.post .post-content blockquote { margin: 0 0 30px; margin-left: -26px; border-left: 3px solid #57ad68; padding-left: 20px; }
.post .post-content blockquote p { letter-spacing: 0.01rem; font-weight: 400; mborder-left: 3px solid #57ad68; mpadding-left: 20px; mmargin-left: -26px; padding-bottom: 3px; }
.post .post-content ul, .post .post-content ol { padding: 0 0 30px; margin: 0; }
.post .post-content li { padding: 0; font-weight: 400; font-style: normal; font-size: 23px; line-height: 30px; margin-left: 30px; margin-bottom: 12px; padding-top: 2px; }
.post .post-content li p { padding: 0 0 1.618rem; }
.post .post-content ol li { list-style-type: decimal; }
.post .bottom-teaser { padding: 50px 0 0 0; font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .bottom-teaser hr { border: 0; padding: 0; display: block; width: 15%; margin: 16px 0 16px 100px; border: 0px solid #dddddd; border-top: 1px solid #dddddd; }
.post .bottom-teaser .isLeft { float: left; width: 47%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .post .bottom-teaser .isLeft { width: 100%; padding-bottom: 32px; } }
.post .bottom-teaser .isLeft .bio { margin-top: 18px; margin-bottom: 18px; }
.post .bottom-teaser .isLeft .username { margin-left: 4px; margin-right: 18px; margin-bottom: 18px; }
.post .bottom-teaser .isLeft .index-headline { padding-bottom: 32px; }
.post .bottom-teaser .isLeft a { color: black; text-decoration: none; }
.post .bottom-teaser .isLeft a:hover { color: #333333; text-decoration: underline; }
.post .bottom-teaser .isLeft .author-image { display: block; width: 80px; height: 80px; float: left; background-size: cover; border-radius: 100%; text-indent: -9999px; }
.post .bottom-teaser .isLeft h4 { font-size: 18px; line-height: 1.1; font-weight: 700; padding: 0; margin: 0; padding-left: 100px; }
.post .bottom-teaser .isLeft p { font-size: 14px; line-height: 1.3; font-weight: 400; padding: 0; margin: 0; padding-left: 100px; }
.post .bottom-teaser .isLeft p.published { color: #999999; }
.post .bottom-teaser .isRight { float: right; width: 47%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .post .bottom-teaser .isRight { width: 100%; } }
.post .bottom-teaser .isRight .index-headline { padding-bottom: 32px; }
.post .bottom-teaser .isRight .site-footer { margin: 0; padding: 0; color: #333333; text-align: left; font-size: 14px; line-height: 1.3; color: #999999; }
.post .bottom-teaser .isRight .site-footer a { color: #333333; text-decoration: none; }
.post .bottom-teaser .isRight .site-footer a:hover { text-decoration: underline; }
.post .bottom-teaser .isRight .site-footer .poweredby { display: block; padding-bottom: 18px; font-weight: 700; color: #333333; }

.share { text-align: right; padding: 20px 0 0; }
.share a { text-decoration: none; color: #bbbbbb; padding-left: 12px; }
.share a .hidden { display: none; }
.share a:hover { color: #333333; }

pre, code { font-size: 15px; border: 1px solid #e8e8e8; border-radius: 3px; background-color: #eeeeff; }

code { padding: 1px 5px; }

pre { padding: 8px 12px; overflow-x: scroll; }
pre > code { border: 0; padding-right: 0; padding-left: 0; }

amp-img {
  text-align: center;
}

.page-link.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

code.highlighter-rouge {
  word-wrap: break-word;
}

.post a {
  color: #333;
  border-bottom: 1px solid;
  text-decoration: none;
}

.post a, .post a:link, .post a:visited {
  background-image: none;
  color: #333;
  text-decoration: none;
}

.site-header .page-links{
  font-size: 1.2em;
}

.page-link {
  padding: 0px 5px 0px 5px;
}

.site-header {
  padding-bottom: 10px;
}

.link {
  color: #333;
  border-bottom: 1px solid;
  text-decoration: none;
}

.author-header h2 {
  margin-bottom: 10px;
}

.author-header p {
  margin-top: 5px;
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  font-size: 1.2em;
  opacity: 0.90;
  color: #ff6200;
}

.site-header {
  text-align: center;
}

.content .post {
  padding-top: 0px;
}

.site-header .page-links {
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  font-size: 1.2em;
}

.post a.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

a.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

.page-navigation {
  display: block;
  width: auto;
  overflow: hidden;
}

.page-navigation a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.navigation-link {
  color: #333;
  text-decoration: underline;
}

.page-navigation .next {
  text-align: right;
}

body p, body a {
  line-height: 1.7;
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;

}

    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>

    
<!-- Google Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": {
      "@type":"WebPage",
      "@id":"https://pawelurbanek.comamp/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku"
    },
    "headline": "Reduce Rails Memory Usage, Fix R14 and Save Money on Heroku",
    "image": {
      "@type": "ImageObject",
      "url": "https://pawelurbanek.com/assets/pig-represents-saving-money-on-heroku-2d7543382abaf45f25c54acb474d389536034d92a759e0317178e6d1f3ac2f15.jpg",
      "height": 500,
      "width": 800
    },
    "datePublished": "2018-01-15",
    "dateModified": "2018-02-07",
    "author": {
      "@type": "Person",
      "name": "Paweł Urbanek"
    },
    "publisher": {
      "@type": "Organization",
      "name": "PabloWeb Paweł Urbanek",
      "logo": {
        "@type": "ImageObject",
        "url": "https://pawelurbanek.com/assets/pabloweb-69223ab6871fe2232fabdd00e23d420a15170da8a9644aee5f73a422067629c4.jpg",
        "width": 600,
        "height": 60
      }
    },
    "description": "In theory, you can run both Rails web server and Sidekiq process on one 512mb Heroku dyno. For side projects with small traffic, saving $7/month always comes in handy. Unfortunately when trying to fit two Ruby processes on one dyno you can run into memory issues. In this post, I will explain how you can limit memory usage in Rails apps.",
    "keywords": "ruby, rails, memory, heroku, save money, startup, optimization, full stack, r14 error"
  }
  </script>


  </head>
  <body>
  <amp-analytics type="googleanalytics">
    <script type="application/json">
    {
      "vars": {
        "account": "UA-34244867-12"
      },
      "triggers": {
        "trackPageview": {
          "on": "visible",
          "request": "pageview"
        }
      }
    }
    </script>
  </amp-analytics>


<main class="content" role="main">
<header class="site-header">
  <div class='author-header'>
    <h2>Paweł Urbanek</h2>
    <p class='theme-color'>Full Stack Blog</p>
  </div>
   <div class="page-links theme-color">
     <a class="page-link theme-color" href="/">Home</a>
     <a class="page-link theme-color" href="/about">About</a>
     <a class="page-link theme-color" href="/contact">Contact</a>
   </div>
</header>
<article class="post">
  <h1 class="blog-title">
    Reduce Rails Memory Usage, Fix R14 and Save Money on Heroku
  </h1>
  <p>
    This is an AMP version of this page
    <a class='theme-color' href="/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku"> click here</a>
    to see the oryginal version.
  </p>
  <p><amp-img class="center-image post-main-image" alt="Reduce costs on Heroku, represented by a pig image" src="/assets/pig-represents-saving-money-on-heroku-2d7543382abaf45f25c54acb474d389536034d92a759e0317178e6d1f3ac2f15.jpg" width="800" height="500" layout="responsive"><noscript><img class="center-image post-main-image" alt="Reduce costs on Heroku, represented by a pig image" src="/assets/pig-represents-saving-money-on-heroku-2d7543382abaf45f25c54acb474d389536034d92a759e0317178e6d1f3ac2f15.jpg" width="800" height="500"></noscript></amp-img></p>

<p>In theory, you can run both Rails web server and Sidekiq process on one 512mb Heroku dyno. For side projects with small traffic, saving $7/month always comes in handy. Unfortunately when trying to fit two Ruby processes on one dyno you can run into memory issues. In this post, I will explain how you can reduce memory usage in Rails apps.</p>

<p>Recently, I read a <a href="https://bilalbudhani.com/running-sidekiq-on-heroku-free-dyno/" target="_blank">great article</a> by Bilal Budhani explaining how to run Sidekiq process alongside Puma on one Heroku dyno. After applying it to <a href="https://wishlist.apki.io" target="_blank">one of my side projects</a>, I started running into those dreaded R14 errors.</p>

<p><amp-img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby errors" src="/assets/R14_error-26587125dc2d34675e70602c79431a4e9f415953276fdeff86bfcf88bb1c3c36.png" width="2373" height="726" layout="responsive"><noscript><img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby errors" src="/assets/R14_error-26587125dc2d34675e70602c79431a4e9f415953276fdeff86bfcf88bb1c3c36.png" width="2373" height="726"></noscript></amp-img></p>

<p><span class="annotation">Memory usage spiked followed by a bunch of memory errors and automatic restart</span></p>

<p>I did some digging and, after a couple of optimizations memory usage charts started looking like this:</p>

<p><amp-img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby fixed" src="/assets/R14_fixed-2f03942be78002ee38a8e10aa0ce798d8e4d0dd883b3c41ac23084ce5dbd37b2.png" width="2373" height="736" layout="responsive"><noscript><img class="center-image" alt="Heroku R14 - Memory Quota Exceeded in Ruby fixed" src="/assets/R14_fixed-2f03942be78002ee38a8e10aa0ce798d8e4d0dd883b3c41ac23084ce5dbd37b2.png" width="2373" height="736"></noscript></amp-img></p>

<p><span class="annotation">Stable memory usage followed by garbage collection</span></p>

<p>Here’s what I did:</p>

<h2 id="put-your-gemfile-on-a-diet">Put your Gemfile on a diet</h2>

<p><em>There is a Gem for that…</em> In the Ruby world, dropping in a Gem to solve a problem is usually the <em>“easiest”</em> solution. Apart from other costs, memory bloat is one that can easily get overlooked.</p>

<p>The best way to check how much memory each of your gems consumes is to use <a href="https://github.com/schneems/derailed_benchmarks" target="_blank">derailed benchmarks</a>. Just add:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'derailed_benchmarks'</span><span class="p">,</span> <span class="ss">group: :development</span></code></pre></figure>

<p>to your <code class="highlighter-rouge">Gemfile</code> and run <code class="highlighter-rouge">bundle exec derailed bundle:mem</code>.</p>

<p>My project powers <a href="https://twitter.com/apps_wishlist" target="_blank">Twitter</a> and <a href="https://www.facebook.com/SmartWishlistiOS/" target="_blank">Facebook</a> bot profiles. I was surprised to find out that a popular <a href="https://github.com/sferik/twitter" class="link" target="_blank">twitter</a> gem uses over <code class="highlighter-rouge">13 MB</code> of memory on startup. First I replaced it with its lightweight alternative <a href="https://github.com/hayesdavis/grackle" target="_blank">grackle</a> (<code class="highlighter-rouge">~1 MB</code>) and finally ended up writing a custom code making a HTTP call to Twitter API. I also managed to get rid of <a href="https://github.com/arsduo/koala" target="_blank">koala</a> gem (<code class="highlighter-rouge">~2 MB</code>) in the same way.</p>

<p>Another quick win was replacing <a href="https://github.com/gazay/gon" target="_blank">gon</a> gem (<code class="highlighter-rouge">~6 MB</code>) with custom JavaScript data attributes.</p>

<p>Importing a couple of MBs worth of gem files to simplify making one HTTP call or preventing writing a couple of JavaScript lines should definitely be avoided.</p>

<h2 id="use-jemalloc-to-reduce-rails-memory-usage">Use jemalloc to reduce Rails memory usage</h2>

<p><a href="http://jemalloc.net/">jemalloc</a> is an alternative to official MRI memory allocator. On Heroku, you can add jemalloc using a <a href="https://github.com/gaffneyc/heroku-buildpack-jemalloc" class="link" target="_blank">buildpack</a>. For my app, it resulted in ~20% memory usage decrease. Just make sure to test your app with jemalloc thoroughly on a staging environment before deploying it to production.</p>

<h2 id="limit-concurrency-and-workers">Limit concurrency and workers</h2>

<p>For a side project with limited traffic you probably don’t need a lot of throughput anyway. You can limit memory usage by reducing Sidekiq and Puma workers and threads count. Here’s my <code class="highlighter-rouge">config/puma.rb</code> file:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">threads_count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">threads</span> <span class="n">threads_count</span><span class="p">,</span> <span class="n">threads_count</span>
<span class="n">port</span>        <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"PORT"</span><span class="p">)</span> <span class="p">{</span> <span class="mi">3000</span> <span class="p">}</span>
<span class="n">environment</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"RAILS_ENV"</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"production"</span> <span class="p">}</span>
<span class="n">workers</span> <span class="mi">1</span>

<span class="n">preload_app!</span>

<span class="n">on_worker_boot</span> <span class="k">do</span>
  <span class="vi">@sidekiq_pid</span> <span class="o">||=</span> <span class="n">spawn</span><span class="p">(</span><span class="s1">'bundle exec sidekiq -t 1'</span><span class="p">)</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">on_restart</span> <span class="k">do</span>
  <span class="no">Sidekiq</span><span class="p">.</span><span class="nf">redis</span><span class="p">.</span><span class="nf">shutdown</span> <span class="p">{</span> <span class="o">|</span><span class="n">conn</span><span class="o">|</span> <span class="n">conn</span><span class="p">.</span><span class="nf">close</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">plugin</span> <span class="ss">:tmp_restart</span></code></pre></figure>

<p>and <code class="highlighter-rouge">config/sidekiq.yml</code>:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="nn">---</span>
<span class="s">:concurrency</span><span class="pi">:</span> <span class="s">1</span>
<span class="s">:queues</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">default</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">critical</span><span class="pi">,</span> <span class="nv">100</span><span class="pi">]</span></code></pre></figure>

<p>Although we specify 1 as the max number of threads, Puma can <a href="https://github.com/puma/puma#thread-pool" target="_blank">spawn up to 7 threads</a>. With those minimal settings, <a href="http://wishlist.apki.io/" target="_blank">Smart Wishlist</a> is still able to process around 100k Sidekiq jobs daily and serve both React frontend and mobile JSON API.</p>

<h2 id="optimize-json-parsing">Optimize JSON parsing</h2>

<p>All those Sidekiq jobs are necessary to download up to date prices from iTunes API (requests batching is on my TODO list) and send push notifications about discounts. This means there’s quite a lot of JSON parsing going on there. There is an oneline fix which can help optimize both memory usage and performance in such cases:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'yajl-ruby'</span><span class="p">,</span> <span class="ss">require: </span><span class="s1">'yajl/json_gem'</span></code></pre></figure>

<p><a href="https://github.com/brianmario/yajl-ruby" target="_blank">yaji-ruby</a> offers a JSON gem Compatibility API, which hooks into <code class="highlighter-rouge">JSON.parse</code> calls, improving their performance and memory usage.</p>

<h2 id="summary">Summary</h2>

<p>Working in constrained environments is a great way to flex your programming muscles and discover new optimization techniques. In theory, you could always solve memory issues by throwing more money at your servers, but why not keep those $7 instead?</p>

<p>Check out my other blog post for more tips on how to <a href="https://pawelurbanek.com/2018/02/05/optimize-rails-performance-bottleneck-with-caching-and-rack-middleware/">improve performance and reduce memory usage of Rails apps</a>.</p>


  </article>
  <div class="page-navigation">
  
    <a class="prev navigation-link" href="/amp/2018/01/08/productive-laziness-optimize-your-shell-workflow">&laquo; Productive Laziness - Optimize your Shell Workflow</a>
  
  
    <a class="right next navigation-link" href="/amp/2018/01/22/setup-multiple-domains-with-free-ssl-from-cloudflare"> Multiple Domains with Free Wildcard SSL from Cloudflare &raquo;</a>
  
</div>

<div class="post-footer">
  <p>
    Posted by Paweł Urbanek on Jan 15, 2018
    <br>
    <br>
    Find me on <a class='link' target='_blank' href="https://twitter.com/_pawurb">Twitter</a> or <a class='link' target='_blank' href="https://github.com/pawurb">GitHub</a>.
  </p>
    <p>
    This is an AMP version of this page
    <a class='link theme-color' href="/2018/01/15/limit-rails-memory-usage-fix-R14-and-save-money-on-heroku"> click here</a>
    to see the oryginal version and comments.
  </p>
</div>

</main>
</body>
</html>

