<!doctype html>
<html amp lang="en">
  <head>
    <meta charset="utf-8">
    <title>Ruby on Rails Simple Service Objects and Testing in Isolation</title>
    <link rel="canonical" href="https://pawelurbanek.com/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet'>
    <style amp-custom>
       /** Syntax highlighting styles */
.highlight { background: #fff; }
.highlighter-rouge .highlight { background: #eef; }
.highlight .c { color: #998; font-style: italic; }
.highlight .err { color: #a61717; background-color: #e3d2d2; }
.highlight .k { font-weight: bold; }
.highlight .o { font-weight: bold; }
.highlight .cm { color: #998; font-style: italic; }
.highlight .cp { color: #999; font-weight: bold; }
.highlight .c1 { color: #998; font-style: italic; }
.highlight .cs { color: #999; font-weight: bold; font-style: italic; }
.highlight .gd { color: #000; background-color: #fdd; }
.highlight .gd .x { color: #000; background-color: #faa; }
.highlight .ge { font-style: italic; }
.highlight .gr { color: #a00; }
.highlight .gh { color: #999; }
.highlight .gi { color: #000; background-color: #dfd; }
.highlight .gi .x { color: #000; background-color: #afa; }
.highlight .go { color: #888; }
.highlight .gp { color: #555; }
.highlight .gs { font-weight: bold; }
.highlight .gu { color: #aaa; }
.highlight .gt { color: #a00; }
.highlight .kc { font-weight: bold; }
.highlight .kd { font-weight: bold; }
.highlight .kp { font-weight: bold; }
.highlight .kr { font-weight: bold; }
.highlight .kt { color: #458; font-weight: bold; }
.highlight .m { color: #099; }
.highlight .s { color: #d14; }
.highlight .na { color: #008080; }
.highlight .nb { color: #0086B3; }
.highlight .nc { color: #458; font-weight: bold; }
.highlight .no { color: #008080; }
.highlight .ni { color: #800080; }
.highlight .ne { color: #900; font-weight: bold; }
.highlight .nf { color: #900; font-weight: bold; }
.highlight .nn { color: #555; }
.highlight .nt { color: #000080; }
.highlight .nv { color: #008080; }
.highlight .ow { font-weight: bold; }
.highlight .w { color: #bbb; }
.highlight .mf { color: #099; }
.highlight .mh { color: #099; }
.highlight .mi { color: #099; }
.highlight .mo { color: #099; }
.highlight .sb { color: #d14; }
.highlight .sc { color: #d14; }
.highlight .sd { color: #d14; }
.highlight .s2 { color: #d14; }
.highlight .se { color: #d14; }
.highlight .sh { color: #d14; }
.highlight .si { color: #d14; }
.highlight .sx { color: #d14; }
.highlight .sr { color: #009926; }
.highlight .s1 { color: #d14; }
.highlight .ss { color: #990073; }
.highlight .bp { color: #999; }
.highlight .vc { color: #008080; }
.highlight .vg { color: #008080; }
.highlight .vi { color: #008080; }
.highlight .il { color: #099; }

.icon > svg { display: inline-block; width: 16px; height: 16px; vertical-align: middle; }
.icon > svg path { fill: #828282; }

amp-img { background-color: grey; }

.cf:after { content: ""; display: table; clear: both; }

main { display: block; }

body { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; margin: 0; padding: 0; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-font-feature-settings: "liga=1, dlig=1"; -ms-font-feature-settings: "liga", "dlig"; -webkit-font-feature-settings: "liga", "dlig"; -o-font-feature-settings: "liga", "dlig"; font-feature-settings: "liga", "dlig"; }

.site-header { position: relative; width: 100%; max-width: 700px; margin: 16px auto 0 auto; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .site-header { padding: 0 16px; } }
.site-header .page-links { display: block;  font-weight: 400; font-style: normal; font-size: 18px; line-height: 30px; }
.site-header .page-links a { text-decoration: none; }

.blog-header { width: 100%; max-width: 700px; margin: 0 auto; position: relative; padding: 0; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
.blog-header .blog-title { margin-bottom: 8px; font-size: 50px; font-weight: 700; letter-spacing: -2px; outline: 0; line-height: 50px; word-break: break-word; color: #333333; }
.blog-header .blog-description { font-size: 28px; margin: 0 0 20px; padding: 0; line-height: 1.2; color: #666666; font-weight: 300; }

.content { width: 100%; max-width: 700px; margin: 25px auto 0 auto; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .content { padding: 0 16px; } }
.content article { padding: 20px 0; border-bottom: 1px solid #f2f2f0; }
.content article:last-child { border-bottom: 0px; }
.content article .post-title { letter-spacing: -0.02em; font-weight: 700; font-style: normal; display: block; font-size: 36px; line-height: 1.15; margin: 0 0; }
.content article .post-title a { text-decoration: none; color: #333332; }
.content article .post-title a:hover { text-decoration: none; }
.content article .post-excerpt { letter-spacing: -0.02em; font-weight: 300; font-style: normal; font-size: 20px; line-height: 1.59; color: #666665; }
.content article .post-meta { font-size: 14px; color: #b3b3b1; line-height: 30px; }
.content article .post-meta a { color: #b3b3b1; text-decoration: none; }
.content article .post-meta a:hover { text-decoration: underline; }

.post-template .content { max-width: 700px; }

.index-headline { border-top: 1px solid #dededc; margin: 0; padding: 16px 0; }
.index-headline span { color: #b3b3b1; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

.pagination { text-align: center; padding: 16px 0 0; font-size: 12px; }
.pagination a { color: #999999; text-decoration: none; }
.pagination a:hover { color: #333333; }

.site-footer { margin: 0 auto; padding: 48px 0; width: 100%; max-width: 700px; font-size: 12px; text-align: center; color: #999999; line-height: 17.6px; }
.site-footer a { color: #666666; text-decoration: none; }
.site-footer a:hover { color: #333333; }

.post .post-meta { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-title { font-weight: 700; font-style: normal; letter-spacing: -0.04em; font-size: 50px; line-height: 1.1; color: #333332; margin-bottom: 50px; }
.post .author-image { background-image: url(/amplify//assets/images/author.jpg); display: inline-block; width: 30px; height: 30px; line-height: 30px; margin-right: 8px; margin-bottom: -10px; float: left; background-size: cover; border-radius: 100%; text-indent: -9999px; }
.post .post-meta-text { color: #b3b3b1; letter-spacing: -0.02em; font-weight: 400; font-style: normal; font-size: 14px; overflow: hidden; font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; white-space: nowrap; text-overflow: ellipsis; }
.post .post-content { width: 100%; font-family: "Merriweather",Georgia, Cambria, "Times New Roman", Times, "Lora", serif; color: #333333; }
.post .post-content h1, .post .post-content h2, .post .post-content h3 { font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-content h3, .post .post-content h4, .post .post-content h5, .post .post-content h6 { letter-spacing: -0.02em; font-weight: 700; font-style: normal; font-size: 24px; line-height: 1.3; margin-top: 50px; margin-bottom: 0px; font-family: "Lato", "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-content h3 { font-size: 36px; }
.post .post-content h2, .post .post-content h1 { letter-spacing: -0.02em; font-weight: 700; font-style: normal; font-size: 42px; line-height: 1.2; margin-top: 50px; margin-bottom: 0px; }
.post .post-content p { font-weight: 400; font-style: normal; font-size: 22px; line-height: 1.59; letter-spacing: -.002em; margin-top: 30px; margin-bottom: 0; color: #333333; -webkit-hyphens: auto; -moz-hyphens: auto; hyphens: auto; }
.post .post-content a { color: #333333; text-decoration: underline; }
.post .post-content amp-img, .post .post-content amp-youtube { margin-top: 30px; }
.post .post-content figure { margin: 0; padding: 0 0 30px; }
.post .post-content figcaption { font-weight: 400; font-style: italic; font-size: 16px; line-height: 1.3; color: #666665; outline: 0; z-index: 300; text-align: center; }
.post .post-content hr { border: 0; padding: 0; display: block; width: 15%; margin: 30px auto; border: 0px solid #dddddd; border-top: 1px solid #dddddd; }
.post .post-content blockquote { margin: 0 0 30px; margin-left: -26px; border-left: 3px solid #57ad68; padding-left: 20px; }
.post .post-content blockquote p { letter-spacing: 0.01rem; font-weight: 400; mborder-left: 3px solid #57ad68; mpadding-left: 20px; mmargin-left: -26px; padding-bottom: 3px; }
.post .post-content ul, .post .post-content ol { padding: 0 0 30px; margin: 0; }
.post .post-content li { padding: 0; font-weight: 400; font-style: normal; font-size: 23px; line-height: 30px; margin-left: 30px; margin-bottom: 12px; padding-top: 2px; }
.post .post-content li p { padding: 0 0 1.618rem; }
.post .post-content ol li { list-style-type: decimal; }
.post .bottom-teaser { padding: 50px 0 0 0; font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .bottom-teaser hr { border: 0; padding: 0; display: block; width: 15%; margin: 16px 0 16px 100px; border: 0px solid #dddddd; border-top: 1px solid #dddddd; }
.post .bottom-teaser .isLeft { float: left; width: 47%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .post .bottom-teaser .isLeft { width: 100%; padding-bottom: 32px; } }
.post .bottom-teaser .isLeft .bio { margin-top: 18px; margin-bottom: 18px; }
.post .bottom-teaser .isLeft .username { margin-left: 4px; margin-right: 18px; margin-bottom: 18px; }
.post .bottom-teaser .isLeft .index-headline { padding-bottom: 32px; }
.post .bottom-teaser .isLeft a { color: black; text-decoration: none; }
.post .bottom-teaser .isLeft a:hover { color: #333333; text-decoration: underline; }
.post .bottom-teaser .isLeft .author-image { display: block; width: 80px; height: 80px; float: left; background-size: cover; border-radius: 100%; text-indent: -9999px; }
.post .bottom-teaser .isLeft h4 { font-size: 18px; line-height: 1.1; font-weight: 700; padding: 0; margin: 0; padding-left: 100px; }
.post .bottom-teaser .isLeft p { font-size: 14px; line-height: 1.3; font-weight: 400; padding: 0; margin: 0; padding-left: 100px; }
.post .bottom-teaser .isLeft p.published { color: #999999; }
.post .bottom-teaser .isRight { float: right; width: 47%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
@media only screen and (max-width: 800px) { .post .bottom-teaser .isRight { width: 100%; } }
.post .bottom-teaser .isRight .index-headline { padding-bottom: 32px; }
.post .bottom-teaser .isRight .site-footer { margin: 0; padding: 0; color: #333333; text-align: left; font-size: 14px; line-height: 1.3; color: #999999; }
.post .bottom-teaser .isRight .site-footer a { color: #333333; text-decoration: none; }
.post .bottom-teaser .isRight .site-footer a:hover { text-decoration: underline; }
.post .bottom-teaser .isRight .site-footer .poweredby { display: block; padding-bottom: 18px; font-weight: 700; color: #333333; }

.share { text-align: right; padding: 20px 0 0; }
.share a { text-decoration: none; color: #bbbbbb; padding-left: 12px; }
.share a .hidden { display: none; }
.share a:hover { color: #333333; }

pre, code { font-size: 15px; border: 1px solid #e8e8e8; border-radius: 3px; background-color: #eeeeff; }

code { padding: 1px 5px; }

pre { padding: 8px 12px; overflow-x: scroll; }
pre > code { border: 0; padding-right: 0; padding-left: 0; }

amp-img {
  text-align: center;
}

.page-link.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

code.highlighter-rouge {
  word-wrap: break-word;
}

.post a {
  color: #333;
  border-bottom: 1px solid;
  text-decoration: none;
}

.post a, .post a:link, .post a:visited {
  background-image: none;
  color: #333;
  text-decoration: none;
}

.site-header .page-links{
  font-size: 1.2em;
}

.page-link {
  padding: 0px 5px 0px 5px;
}

.site-header {
  padding-bottom: 10px;
}

.link {
  color: #333;
  border-bottom: 1px solid;
  text-decoration: none;
}

.author-header h2 {
  margin-bottom: 10px;
}

.author-header p {
  margin-top: 5px;
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  font-size: 1.2em;
  opacity: 0.90;
  color: #ff6200;
}

.site-header {
  text-align: center;
}

.content .post {
  padding-top: 0px;
}

.site-header .page-links {
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  font-size: 1.2em;
}

.post a.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

a.theme-color {
  opacity: 0.90;
  color: #ff6200;
}

.page-navigation {
  display: block;
  width: auto;
  overflow: hidden;
}

.page-navigation a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.navigation-link {
  color: #333;
  text-decoration: underline;
}

.page-navigation .next {
  text-align: right;
}

body p, body a {
  line-height: 1.7;
  font-family: "Merriweather", Georgia, Cambria, "Times New Roman", Times, "Lora", serif;

}

    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>

    
<!-- Google Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": {
      "@type":"WebPage",
      "@id":"https://pawelurbanek.comamp/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation"
    },
    "headline": "Ruby on Rails Simple Service Objects and Testing in Isolation",
    "image": {
      "@type": "ImageObject",
      "url": "https://pawelurbanek.com/assets/rails-service-object-gear-00fca702cf4d691fd506ffd727dbaace1ece26354f18c96c644c4e7ac7ea747d.jpg",
      "height": 500,
      "width": 800
    },
    "datePublished": "2018-02-12",
    "dateModified": "2018-02-12",
    "author": {
      "@type": "Person",
      "name": "Paweł Urbanek"
    },
    "publisher": {
      "@type": "Organization",
      "name": "PabloWeb Paweł Urbanek",
      "logo": {
        "@type": "ImageObject",
        "url": "https://pawelurbanek.com/assets/pabloweb-69223ab6871fe2232fabdd00e23d420a15170da8a9644aee5f73a422067629c4.jpg",
        "width": 600,
        "height": 60
      }
    },
    "description": "Service Objects are not a silver bullet but they can take you a long way in modeling your Ruby on Rails app's domain logic. In this blog post, I will describe how I usually work with service object pattern in a structured way. I will also cover a simple testing in isolation with mocked services layer.",
    "keywords": ""
  }
  </script>


  </head>
  <body>
  <amp-analytics type="googleanalytics">
    <script type="application/json">
    {
      "vars": {
        "account": "UA-34244867-12"
      },
      "triggers": {
        "trackPageview": {
          "on": "visible",
          "request": "pageview"
        }
      }
    }
    </script>
  </amp-analytics>


<main class="content" role="main">
<header class="site-header">
  <div class='author-header'>
    <h2>Paweł Urbanek</h2>
    <p class='theme-color'>Full Stack Blog</p>
  </div>
   <div class="page-links theme-color">
     <a class="page-link theme-color" href="/">Home</a>
     <a class="page-link theme-color" href="/about">About</a>
     <a class="page-link theme-color" href="/contact">Contact</a>
   </div>
</header>
<article class="post">
  <h1 class="blog-title">
    Ruby on Rails Simple Service Objects and Testing in Isolation
  </h1>
  <p>
    This is an AMP version of this page
    <a class='theme-color' href="/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation"> click here</a>
    to see the oryginal version.
  </p>
  <p><amp-img class="center-image post-main-image" alt="Gears represent Rails Service objects" src="/assets/rails-service-object-gear-00fca702cf4d691fd506ffd727dbaace1ece26354f18c96c644c4e7ac7ea747d.jpg" width="800" height="500" layout="responsive"><noscript><img class="center-image post-main-image" alt="Gears represent Rails Service objects" src="/assets/rails-service-object-gear-00fca702cf4d691fd506ffd727dbaace1ece26354f18c96c644c4e7ac7ea747d.jpg" width="800" height="500"></noscript></amp-img></p>

<p>Service Objects are not a silver bullet but they can take you a long way in modeling your Rails app’s domain logic. In this blog post, I will describe how I usually work with service object pattern in a structured way. I will also cover testing in isolation with mocked services layer.</p>

<p>I first read about service objects in a great blog post about <a href="https://codeclimate.com/blog/7-ways-to-decompose-fat-activerecord-models/" target="_blank">7 Patterns to Refactor Fat ActiveRecord Models</a>. Since then a new article about them pops up every now and then. I decided to add my two cents.</p>

<h2 id="reasoning-behind-service-objects-in-rails-apps">Reasoning behind Service Objects in Rails apps</h2>

<p>A service object is a way to encapsulate an app’s logic to prevent fat models and cluttered controllers. It is recommended that they should have only one public method. Sticking to this rule enforces you to follow a single responsibility principle and helps to avoid the trap of overcomplicating your services code.</p>

<p>I usually follow the convention where a service object has only one public class method <code class="highlighter-rouge">call</code>. This method instantiates a new service instance and executes it. Let’s look at some code:</p>

<p><code class="highlighter-rouge">app/services/web/user_login.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">UserLogin</span>
  <span class="nb">attr_reader</span> <span class="ss">:omniauth_data</span><span class="p">,</span> <span class="ss">:team_id</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">)</span>
    <span class="vi">@omniauth_data</span> <span class="o">=</span> <span class="n">omniauth_data</span>
    <span class="vi">@team_id</span> <span class="o">=</span> <span class="n">team_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">omniauth_data</span><span class="p">,</span> <span class="n">team_id</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Because <a href="https://pawelurbanek.com/2018/01/08/productive-laziness-optimize-your-shell-workflow/">I am lazy</a> some time ago I created a simple gem. <a href="https://github.com/pawurb/smart_init" target="_blank">Smart Init</a> saves me some typing when creating service objects. This is how a previous example looks written with the help of my gem:</p>

<p><code class="highlighter-rouge">app/services/web/user_login.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">UserLogin</span>
  <span class="kp">extend</span> <span class="no">SmartInit</span>

  <span class="n">initialize_with</span> <span class="ss">:omniauth_data</span><span class="p">,</span> <span class="ss">:team_id</span>
  <span class="n">is_callable</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>It’s not only about avoiding boilerplate code but more about having a default scaffold for building services and saving yourself some thinking. Alternatively, you could use <code class="highlighter-rouge">Struct</code> but it does not check for a number of parameters provided in the initializer, exposes getters and instantiates unnecessary class instances.</p>

<h2 id="mock-service-objects-in-controller-specs">Mock Service Objects in controller specs</h2>

<p>Naming one public method <code class="highlighter-rouge">call</code> is an optimal solution. Not only because <code class="highlighter-rouge">UserAuthenticator#authenticate</code> is unnecessarily redundant, but it allows you to mock your services using a proc object. It comes super handy when you want to test other parts of your application in isolation from services layer.</p>

<p>Let’s say that you want to test how your controller behaves depending on whether a payment operation was successful or not. In theory, your specs could execute the whole checkout process e.g. by using a <a href="https://github.com/vcr/vcr" target="_blank">VCR gem</a>. Unfortunately for any non-trivial flow, it could be difficult to simulate all possible edge cases in an integration test.</p>

<p>Instead, you can use a simple proc object to simulate any outcome of running your services. Let’s take a look at an example controller and spec:</p>

<p><code class="highlighter-rouge">app/controllers/web/subscriptions_controller.rb</code></p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">BaseController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">if</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">head</span> <span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="mi">400</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="no">ExceptionNotifier</span><span class="p">.</span><span class="nf">notify_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">head</span> <span class="mi">500</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p><code class="highlighter-rouge">spec/controllers/web/subscriptions_controller_spec.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"#create"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"payment successful"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1"># proc object, it responds to a 'call' method</span>
          <span class="o">-&gt;</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">201</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"payment failed"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">-&gt;</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">400</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"something went really wrong"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="k">raise</span> <span class="s2">"Unexpected error"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns a correct status code"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">500</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>As you can see not only can you mock returned values but also simulate any kind of side effect because of proc objects being callable chunks of code. Here I used it to raise a runtime exception, but it could be any code. It gives you a real flexibility in simulating edge cases without doing a complex data setup with fixtures/factories.</p>

<h2 id="beyond-true-and-false-enums-for-control-flow">Beyond true and false; “Enums” for control flow</h2>

<p>In the previous example, I used a single if/else statement to detect if an operation was successful and exception handling for critical edge cases. In practice, operation result is not always as simple as success or failure and you might need to handle more than 2 possible outcomes.</p>

<p>I work mainly in Swift nowadays and one of the features I miss the most when I come back to Ruby are enums. I am not talking about database Rails enums here. A real enum is a variable which can have only predefined values and it is validated during a compile time.</p>

<p>Obviously, there is no such thing as compile-time validation in Ruby, and the closest thing to enums I managed to come up with is an array of constants. You could use this technique to provide at least a minimal protection from typos if you would like your services to return different “status codes” as a result of their execution. Let’s take a look at an example:</p>

<p><code class="highlighter-rouge">app/services/subscription/maker.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Subscription</span><span class="o">::</span><span class="no">Maker</span>
  <span class="kp">extend</span> <span class="no">SmartInit</span>

  <span class="n">initialize_with</span> <span class="ss">:params</span>
  <span class="n">is_callable</span>

  <span class="no">RESULTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="no">PAYMENT_SUCCESS</span> <span class="o">=</span> <span class="ss">:payment_success</span><span class="p">,</span>
    <span class="no">INSUFFICIENT_FOUNDS</span> <span class="o">=</span> <span class="ss">:insufficient_founds</span><span class="p">,</span>
    <span class="no">INVALID_CARD_DATA</span> <span class="o">=</span> <span class="ss">:invalid_card_data</span><span class="p">,</span>
    <span class="no">GATEWAY_TIMEOUT</span> <span class="o">=</span> <span class="ss">:gateway_timeout</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="no">PAYMENT_SUCCESS</span> <span class="k">if</span> <span class="n">sth</span>
    <span class="k">return</span> <span class="no">INSUFFICIENT_FOUNDS</span> <span class="k">if</span> <span class="n">sth_else</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>In the controller you can switch on a result of service execution:</p>

<p><code class="highlighter-rouge">app/controllers/web/subscriptions_controller.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Web</span><span class="o">::</span><span class="no">SubscriptionsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">BaseController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">case</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">PAYMENT_SUCCESS</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">INSUFFICIENT_FOUNDS</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">INVALID_CARD_DATA</span>
      <span class="o">...</span>
    <span class="k">when</span> <span class="no">Subscription</span><span class="o">::</span><span class="no">Maker</span><span class="o">::</span><span class="no">GATEWAY_TIMEOUT</span>
      <span class="o">...</span>
    <span class="n">default</span>
      <span class="k">raise</span> <span class="s2">"It should never happen! ☠☠☠"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>As you can see because of how Ruby handles constant namespaces, you can access them directly and not necessarily through <code class="highlighter-rouge">RESULTS</code> array. It is a bit verbose but still better than tracking a typo bug for hours.</p>

<h2 id="final-remarks">Final remarks</h2>

<p>I hope that some of those tips would prove useful in how you work with services in your apps. I am open to suggestions on what could be improved in what I describe.</p>


  </article>
  <div class="page-navigation">
  
    <a class="prev navigation-link" href="/amp/2018/02/05/optimize-rails-performance-bottleneck-with-caching-and-rack-middleware">&laquo; Optimize Rails Performance with Redis Caching and Rack Middleware</a>
  
  
    <a class="right next navigation-link" href="/amp/2018/02/16/seo-tips-for-technical-bloggers-and-programming-blogs-in-2018"> SEO Tips for Programming Blogs and Technical Bloggers in 2018 &raquo;</a>
  
</div>

<div class="post-footer">
  <p>
    Posted by Paweł Urbanek on Feb 12, 2018
    <br>
    <br>
    Find me on <a class='link' target='_blank' href="https://twitter.com/_pawurb">Twitter</a> or <a class='link' target='_blank' href="https://github.com/pawurb">GitHub</a>.
  </p>
    <p>
    This is an AMP version of this page
    <a class='link theme-color' href="/2018/02/12/ruby-on-rails-service-objects-and-testing-in-isolation"> click here</a>
    to see the oryginal version and comments.
  </p>
</div>

</main>
</body>
</html>

